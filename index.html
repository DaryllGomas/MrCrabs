<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Research Dashboard - October 7, 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e6f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .dashboard-header {
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px 40px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .date-badge {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .error-banner {
            display: none;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fecaca;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .error-banner.active {
            display: block;
        }
        
        .sentiment-overview {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sentiment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .sentiment-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .sentiment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
        }
        
        .sentiment-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .sentiment-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #6366f1;
        }
        
        .allocation-chart {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .chart-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            position: relative;
        }
        
        .allocation-legend {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .provider-insights {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .provider-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .provider-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .provider-card:hover::before {
            transform: scaleX(1);
        }
        
        .provider-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.2);
        }
        
        .provider-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #8b5cf6;
        }
        
        .key-insight {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid #6366f1;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.05);
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .risk-monitor {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .risk-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .risk-items {
            display: grid;
            gap: 15px;
        }
        
        .risk-item {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            padding: 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .risk-item:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: translateX(5px);
        }
        
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            position: relative;
        }
        
        .tab:hover {
            color: #e0e6f0;
        }
        
        .tab.active {
            color: #6366f1;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            right: 0;
            height: 2px;
            background: #6366f1;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 30px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        
        /* QUICK ACTIONS PANEL */
        .quick-actions-panel {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .quick-action-card {
            background: rgba(26, 31, 58, 0.8);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-action-card.urgency-high {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .quick-action-card.urgency-medium {
            border-left-color: #eab308;
            background: rgba(234, 179, 8, 0.05);
        }

        .quick-action-card.urgency-low {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .quick-action-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2);
        }

        .action-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .action-icon {
            font-size: 1.5em;
        }

        .action-title {
            font-size: 0.9em;
            color: #9ca3af;
        }

        .action-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #e0e6f0;
            margin-bottom: 8px;
        }

        .action-description {
            font-size: 0.85em;
            color: #6b7280;
        }

        /* SENTIMENT TIMELINE */
        .sentiment-timeline {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .timeline-chart {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        /* PROVIDER CONSENSUS HEATMAP */
        .consensus-heatmap {
            background: rgba(26, 31, 58, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .consensus-items {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .consensus-item {
            background: rgba(10, 14, 39, 0.4);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .consensus-topic {
            flex: 0 0 150px;
            font-weight: bold;
            color: #e0e6f0;
        }

        .consensus-bar-container {
            flex: 1;
            height: 30px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .consensus-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #6366f1);
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .consensus-bar.divergence {
            background: linear-gradient(90deg, #ef4444, #f59e0b);
        }

        .consensus-percentage {
            flex: 0 0 60px;
            text-align: right;
            font-weight: bold;
            color: #6366f1;
        }

        .divergence-badge {
            flex: 0 0 auto;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        /* DAILY PLANNER TAB STYLES */
        .planner-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .session-indicator {
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        /* Session quality color coding */
        .session-quality-optimal {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.25));
            border: 2px solid rgba(16, 185, 129, 0.6);
        }

        .session-quality-good {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.25), rgba(202, 138, 4, 0.25));
            border: 2px solid rgba(234, 179, 8, 0.6);
        }

        .session-quality-poor {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        .session-quality-neutral {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border: 2px solid rgba(99, 102, 241, 0.4);
        }

        .session-name {
            font-size: 1.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .session-quality-optimal .session-name {
            background: linear-gradient(45deg, #10b981, #059669);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .session-quality-good .session-name {
            background: linear-gradient(45deg, #eab308, #ca8a04);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .session-quality-poor .session-name {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .session-quality-neutral .session-name {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .session-time {
            color: #9ca3af;
            margin-top: 5px;
        }

        .priorities-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .priority-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .priority-item:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }

        .priority-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .priority-checkbox.checked {
            background: #6366f1;
        }

        .priority-checkbox.checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .priority-item.high { border-left: 3px solid #ef4444; }
        .priority-item.medium { border-left: 3px solid #eab308; }
        .priority-item.low { border-left: 3px solid #10b981; }

        .key-levels-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .level-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }

        .level-table th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            color: #9ca3af;
            font-size: 0.85em;
        }

        .level-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .level-asset {
            font-weight: bold;
            color: #6366f1;
        }

        .scheduled-events-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .event-time {
            color: #6366f1;
            font-weight: bold;
        }

        .event-impact {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .event-impact.high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .event-impact.medium {
            background: rgba(234, 179, 8, 0.2);
            color: #fde047;
        }

        .event-impact.low {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .event-ai-note {
            color: #9ca3af;
            font-size: 0.9em;
            margin-top: 6px;
            line-height: 1.3;
        }

        /* Signal Data Styling */
        .signal-data-section {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .signal-score-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .signal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .signal-composite-score {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .signal-tier {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .tier-extreme-buy {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
            border: 2px solid #22c55e;
        }

        .tier-strong-buy {
            background: rgba(16, 185, 129, 0.3);
            color: #34d399;
            border: 2px solid #10b981;
        }

        .tier-moderate-buy {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            border: 2px solid #3b82f6;
        }

        .tier-weak {
            background: rgba(234, 179, 8, 0.3);
            color: #fde047;
            border: 2px solid #eab308;
        }

        .tier-avoid {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border: 2px solid #ef4444;
        }

        .signal-setup {
            background: rgba(139, 92, 246, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .signal-breakdown {
            margin-top: 20px;
        }

        .breakdown-title {
            color: #9ca3af;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .breakdown-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .breakdown-item {
            display: grid;
            grid-template-columns: 140px 1fr 70px;
            align-items: center;
            gap: 12px;
        }

        .breakdown-label {
            color: #d1d5db;
            font-size: 0.9em;
        }

        .breakdown-bar-container {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .breakdown-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .breakdown-value {
            color: #6366f1;
            font-weight: bold;
            font-size: 0.9em;
            text-align: right;
        }

        .signal-recommendation {
            margin-top: 20px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
            border-radius: 8px;
            color: #4ade80;
            font-size: 0.95em;
            line-height: 1.6;
        }

        @media (max-width: 968px) {
            .planner-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .provider-insights {
                grid-template-columns: 1fr;
            }

            .chart-container {
                flex-direction: column;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .consensus-item {
                flex-direction: column;
                align-items: stretch;
            }

            .consensus-topic {
                flex: 1;
            }
        }

        /* ECONOMIC CALENDAR STYLES */
        .economic-calendar {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .calendar-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #e0e6f0;
        }

        .calendar-summary {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid #6366f1;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: #c5cfe6;
            line-height: 1.6;
        }

        .calendar-section {
            margin-bottom: 24px;
        }

        .calendar-section-header {
            font-size: 1.1em;
            font-weight: bold;
            color: #a5b4fc;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calendar-event {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.6);
            border-radius: 8px;
            border-left: 3px solid;
            transition: all 0.2s ease;
        }

        .calendar-event:hover {
            background: rgba(31, 41, 55, 0.9);
            transform: translateX(4px);
        }

        .calendar-event.impact-HIGH {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .calendar-event.impact-MEDIUM {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .event-time {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #9ca3af;
            min-width: 90px;
            font-size: 0.95em;
        }

        .event-name {
            flex: 1;
            color: #e0e6f0;
            font-weight: 500;
        }

        .event-impact {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .event-impact.HIGH {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid #ef4444;
        }

        .event-impact.MEDIUM {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid #f59e0b;
        }

        .key-date-card {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .key-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .key-date-date {
            font-weight: bold;
            color: #c4b5fd;
            font-size: 1.05em;
        }

        .key-date-events {
            color: #9ca3af;
            font-size: 0.9em;
            margin-bottom: 6px;
        }

        .key-date-note {
            color: #d8b4fe;
            font-style: italic;
            font-size: 0.95em;
        }

        /* AI INTERPRETATION STYLES */
        .ai-interpretation {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.15));
            border-left: 4px solid #8b5cf6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(45deg, #8b5cf6, #6366f1);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .ai-summary {
            color: #e0e6f0;
            line-height: 1.8;
            margin-bottom: 12px;
            font-size: 1.05em;
        }

        .ai-key-insight {
            background: rgba(234, 179, 8, 0.1);
            border-left: 3px solid #eab308;
            padding: 12px 16px;
            margin: 12px 0;
            border-radius: 6px;
        }

        .ai-key-insight-label {
            color: #eab308;
            font-weight: bold;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .ai-key-insight-text {
            color: #fde047;
            font-style: italic;
            line-height: 1.6;
        }

        .ai-action {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: rgba(16, 185, 129, 0.1);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #10b981;
            margin-top: 12px;
        }

        .ai-action-icon {
            font-size: 1.3em;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .ai-action-text {
            color: #6ee7b7;
            line-height: 1.6;
        }

        .ai-meta {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
        }

        .ai-sentiment,
        .ai-confidence {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

        .ai-sentiment-value,
        .ai-confidence-value {
            padding: 3px 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .sentiment-bullish { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .sentiment-bearish { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .sentiment-neutral { background: rgba(156, 163, 175, 0.2); color: #d1d5db; }
        .sentiment-mixed { background: rgba(234, 179, 8, 0.2); color: #fde047; }
        .sentiment-cautiously-bullish { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }

        .confidence-high { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .confidence-medium { background: rgba(234, 179, 8, 0.2); color: #fde047; }
        .confidence-low { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

        /* RISK MONITOR CATEGORIES */
        .risk-category {
            margin-bottom: 30px;
        }

        .risk-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .risk-category-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e6f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-category-icon {
            font-size: 1.3em;
        }

        /* DIVERGENCE RISK CARDS */
        .divergence-risk-card {
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .divergence-risk-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .divergence-risk-card.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .divergence-risk-card.high {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .divergence-risk-card.medium {
            border-left-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .divergence-risk-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .divergence-consensus-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .divergence-consensus-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .divergence-consensus-badge.high {
            background: rgba(245, 158, 11, 0.2);
            color: #fde047;
        }

        .divergence-consensus-badge.medium {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        .divergence-risk-title {
            font-size: 1.05em;
            font-weight: 600;
            color: #e0e6f0;
            flex: 1;
        }

        .divergence-risk-description {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .divergence-risk-implication {
            background: rgba(16, 185, 129, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 3px solid #10b981;
        }

        .divergence-risk-implication-label {
            color: #10b981;
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .divergence-risk-implication-text {
            color: #6ee7b7;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .provider-tier-badge {
            display: inline-block;
            font-size: 1.1em;
            margin-right: 6px;
        }

        .end-of-day-card {
            background: rgba(56, 189, 248, 0.08);
            border: 1px solid rgba(56, 189, 248, 0.35);
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .end-of-day-card h2 { font-size: 1.2em; margin-bottom: 10px; }
        .end-of-day-card ul { padding-left: 18px; }
        .end-of-day-card li { margin: 4px 0; }

        .close-probability-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body data-plan="./master-plan.md">
    <div class="dashboard-header">
        <div class="header-content">
            <h1 id="dashboard-title"></h1>
            <div class="date-badge" id="dashboard-date"></div>
        </div>
    </div>

    <div class="container">
        <div id="dashboard-error" class="error-banner"></div>

        <!-- QUICK ACTIONS PANEL -->
        <div class="quick-actions-panel">
            <h2 class="section-title">⚡ Immediate Actions</h2>
            <div class="quick-actions-grid" id="quick-actions-grid"></div>
        </div>

        <!-- Market Sentiment Overview -->
        <div class="sentiment-overview">
            <h2 class="section-title">Market Sentiment Overview</h2>
            <div class="sentiment-grid" id="sentiment-grid"></div>
        </div>

        <!-- SENTIMENT TIMELINE -->
        <div class="sentiment-timeline">
            <h2 class="section-title">📊 Sentiment Timeline (Last 30 Days)</h2>
            <canvas id="sentimentChart" class="timeline-chart" width="800" height="150"></canvas>
        </div>

        <!-- KISS Portfolio Allocation -->
        <div class="allocation-chart">
            <h2 id="allocation-title" class="section-title"></h2>
            <div class="chart-container">
                <canvas id="pieChart" class="pie-chart" width="200" height="200"></canvas>
                <div id="allocation-legend" class="allocation-legend"></div>
            </div>
        </div>

        <!-- Key Metrics -->
        <h2 class="section-title">Key Market Metrics</h2>
        <div class="metrics-grid" id="metrics-grid"></div>

        <!-- Provider Insights Tabs -->
        <div class="tabs" id="provider-tabs"></div>
        <div id="provider-contents"></div>

        <!-- PROVIDER CONSENSUS HEATMAP -->
        <div class="consensus-heatmap">
            <h2 class="section-title">🎯 Analyst Consensus</h2>
            <div class="consensus-items" id="consensus-items"></div>
        </div>

        <!-- Risk & Divergence Monitor -->
        <div class="risk-monitor">
            <div class="risk-header">
                <div class="risk-indicator"></div>
                <h2 class="section-title">🚨 Risk & Divergence Monitor</h2>
            </div>
            <div class="risk-items" id="risk-items"></div>
        </div>
    </div>

    <script>
        const SOURCE_FILE = document.body.dataset.plan || 'master-plan.md';

        async function initDashboard() {
            try {
                const cacheBuster = (SOURCE_FILE.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(SOURCE_FILE + cacheBuster, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error('Failed to load ' + SOURCE_FILE + ' (' + response.status + ')');
                }

                const text = await response.text();
                const frontMatterMatch = text.match(/^---\s*([\s\S]*?)\s*---/);
                if (!frontMatterMatch) {
                    throw new Error('Dashboard configuration missing front matter.');
                }

                const config = JSON.parse(frontMatterMatch[1]);
                applyDashboardData(config.dashboard || {});
            } catch (error) {
                console.error(error);
                showError(error.message);
            } finally {
                applyCardAnimations();
            }
        }

        function applyDashboardData(dashboard) {
            if (dashboard.pageTitle) {
                document.title = dashboard.pageTitle;
            }

            const titleEl = document.getElementById('dashboard-title');
            if (titleEl) {
                titleEl.textContent = dashboard.title || 'Investment Research Dashboard';
            }

            const dateEl = document.getElementById('dashboard-date');
            if (dateEl) {
                dateEl.textContent = dashboard.dateBadge || '';
            }

            renderSentimentCards(dashboard.sentimentCards || []);
            renderAllocation(dashboard.allocation || {});
            renderMetrics(dashboard.metrics || []);
            renderProviderTabs(dashboard.tabs || [], dashboard.dailyPlanner, dashboard.endOfDay);

            // Render integrated Risk & Divergence Monitor
            renderRiskAndDivergenceMonitor(dashboard.riskItems || [], dashboard.divergenceAlerts || []);

            // New dashboard features
            if (dashboard.quickActions) renderQuickActions(dashboard.quickActions);
            if (dashboard.sentimentHistory) renderSentimentTimeline(dashboard.sentimentHistory);
            if (dashboard.providerConsensus) renderProviderConsensus(dashboard.providerConsensus);
            // Clean up any garbled icons/text from source data or encoding
            sanitizeUIArtifacts();
        }

        // Fixes any garbled placeholder characters and normalizes key labels/icons
        function sanitizeUIArtifacts() {
            try {
                const qa = document.querySelector('.quick-actions-panel .section-title');
                if (qa) qa.textContent = '⚡ Immediate Actions';

                const st = document.querySelector('.sentiment-timeline .section-title');
                if (st) st.textContent = '📈 Sentiment Timeline (Last 30 Days)';

                const ac = document.querySelector('.consensus-heatmap .section-title');
                if (ac) ac.textContent = 'Analyst Consensus';

                const rm = document.querySelector('.risk-monitor .section-title');
                if (rm) rm.textContent = '⚠️ Risk & Divergence Monitor';

                // AI interpretation badges and labels
                document.querySelectorAll('.ai-badge span:first-child').forEach(el => { el.textContent = '🤖'; });
                document.querySelectorAll('.ai-key-insight-label').forEach(el => { el.textContent = 'Key Insight'; });
                document.querySelectorAll('.ai-action .ai-action-icon').forEach(el => { el.textContent = '⚡'; });

                // Economic calendar headers and separators
                const cal = document.querySelector('.economic-calendar');
                if (cal) {
                    const calIcon = cal.querySelector('.calendar-header span');
                    if (calIcon) calIcon.textContent = '📅';
                    const headers = cal.querySelectorAll('.calendar-section-header');
                    if (headers[0]) headers[0].textContent = 'TODAY';
                    if (headers[1]) headers[1].textContent = 'THIS WEEK';
                    if (headers[2]) headers[2].textContent = 'NEXT WEEK';
                    if (headers[3]) headers[3].textContent = 'KEY DATES THIS MONTH';

                    cal.querySelectorAll('.key-date-events').forEach(el => {
                        el.textContent = el.textContent.replace(/�/g, '•');
                    });
                }

                // Risk monitor icons
                const riskIcons = ['🔥', '⚠️', 'ℹ️'];
                document.querySelectorAll('.risk-category .risk-category-icon').forEach((el, idx) => {
                    el.textContent = riskIcons[idx] || 'ℹ️';
                });

                // Divergence badges and labels
                document.querySelectorAll('.divergence-consensus-badge.critical').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `🔥 ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-consensus-badge.high').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `⚠️ ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-consensus-badge.medium').forEach(el => {
                    const pct = (el.textContent.match(/\d+%/) || [''])[0];
                    el.textContent = `ℹ️ ${pct}`.trim();
                });
                document.querySelectorAll('.divergence-risk-implication-label').forEach(el => {
                    el.textContent = 'Trading Implication';
                });
            } catch (e) {
                console.warn('sanitizeUIArtifacts failed:', e);
            }
        }

        function renderRiskAndDivergenceMonitor(riskItems, divergenceAlerts) {
            const container = document.getElementById('risk-items');
            if (!container) return;

            container.innerHTML = '';

            // Categorize divergence alerts
            const criticalDivergences = divergenceAlerts.filter(d => d.tier === 'CRITICAL');
            const highDivergences = divergenceAlerts.filter(d => d.tier === 'HIGH');
            const mediumDivergences = divergenceAlerts.filter(d => d.tier === 'MEDIUM');

            // Render CRITICAL DIVERGENCES section
            if (criticalDivergences.length > 0) {
                const criticalSection = createRiskCategory('🚨', 'Critical Divergences (Consensus <50%)', 'critical');
                criticalDivergences.forEach(alert => {
                    criticalSection.appendChild(createDivergenceCard(alert, 'critical'));
                });
                container.appendChild(criticalSection);
            }

            // Render HIGH DIVERGENCES section
            if (highDivergences.length > 0) {
                const highSection = createRiskCategory('⚠️', 'High Divergences (Consensus 50-69%)', 'high');
                highDivergences.forEach(alert => {
                    highSection.appendChild(createDivergenceCard(alert, 'high'));
                });
                container.appendChild(highSection);
            }

            // Render MEDIUM DIVERGENCES section
            if (mediumDivergences.length > 0) {
                const mediumSection = createRiskCategory('ℹ️', 'Medium Divergences', 'medium');
                mediumDivergences.forEach(alert => {
                    mediumSection.appendChild(createDivergenceCard(alert, 'medium'));
                });
                container.appendChild(mediumSection);
            }

            // Render TECHNICAL & STRUCTURAL RISKS section
            if (riskItems.length > 0) {
                const techSection = createRiskCategory('📊', 'Technical & Structural Risks', 'technical');
                riskItems.forEach(item => {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'risk-item';

                    const title = document.createElement('div');
                    title.className = 'risk-title';
                    title.textContent = item.title || '';

                    const desc = document.createElement('div');
                    desc.className = 'risk-description';
                    desc.textContent = item.description || '';

                    riskDiv.appendChild(title);
                    riskDiv.appendChild(desc);
                    techSection.appendChild(riskDiv);
                });
                container.appendChild(techSection);
            }
        }

        function createRiskCategory(icon, title, type) {
            const section = document.createElement('div');
            section.className = 'risk-category';

            const header = document.createElement('div');
            header.className = 'risk-category-header';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'risk-category-icon';
            iconSpan.textContent = icon;

            const titleSpan = document.createElement('span');
            titleSpan.className = 'risk-category-title';
            titleSpan.textContent = title;

            header.appendChild(iconSpan);
            header.appendChild(titleSpan);
            section.appendChild(header);

            return section;
        }

        function createDivergenceCard(alert, severity) {
            const card = document.createElement('div');
            card.className = `divergence-risk-card ${severity}`;

            const header = document.createElement('div');
            header.className = 'divergence-risk-header';

            const badge = document.createElement('span');
            badge.className = `divergence-consensus-badge ${severity}`;
            const icon = severity === 'critical' ? '🔴' : severity === 'high' ? '🟡' : '🟢';
            badge.textContent = `${icon} ${alert.agreement}%`;

            const title = document.createElement('span');
            title.className = 'divergence-risk-title';
            title.textContent = alert.topic;

            header.appendChild(badge);
            header.appendChild(title);

            const description = document.createElement('div');
            description.className = 'divergence-risk-description';
            description.textContent = alert.alert;

            const implication = document.createElement('div');
            implication.className = 'divergence-risk-implication';

            const implLabel = document.createElement('div');
            implLabel.className = 'divergence-risk-implication-label';
            implLabel.textContent = '💡 Trading Implication';

            const implText = document.createElement('div');
            implText.className = 'divergence-risk-implication-text';
            implText.textContent = alert.tradingImplication;

            implication.appendChild(implLabel);
            implication.appendChild(implText);

            card.appendChild(header);
            card.appendChild(description);
            card.appendChild(implication);

            return card;
        }

        function renderSentimentCards(cards) {
            const grid = document.getElementById('sentiment-grid');
            if (!grid) {
                return;
            }
            grid.innerHTML = '';

            if (!cards.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No sentiment data available.</p>';
                return;
            }

            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'sentiment-card';
                if (card.id) {
                    cardEl.dataset.topic = card.id;
                    cardEl.addEventListener('click', () => showDetail(card.id));
                }

                const labelEl = document.createElement('div');
                labelEl.className = 'sentiment-label';
                labelEl.textContent = card.label || '';

                const valueEl = document.createElement('div');
                valueEl.className = 'sentiment-value';
                valueEl.textContent = card.value || '';

                const detailEl = document.createElement('div');
                detailEl.style.color = card.detailColor || '#e0e6f0';
                detailEl.style.fontSize = '0.9em';
                detailEl.style.marginTop = '5px';
                detailEl.textContent = card.detail || '';

                cardEl.appendChild(labelEl);
                cardEl.appendChild(valueEl);
                cardEl.appendChild(detailEl);

                cardEl.addEventListener('mouseenter', () => {
                    cardEl.style.transform = 'translateY(-5px) scale(1.02)';
                });

                cardEl.addEventListener('mouseleave', () => {
                    cardEl.style.transform = 'translateY(0) scale(1)';
                });

                grid.appendChild(cardEl);
            });
        }

        function renderAllocation(allocation) {
            const legend = document.getElementById('allocation-legend');
            if (!legend) {
                return;
            }
            legend.innerHTML = '';

            const segments = Array.isArray(allocation.segments) ? allocation.segments : [];
            const titleEl = document.getElementById('allocation-title');
            if (titleEl) {
                titleEl.textContent = allocation.title || 'Portfolio Allocation';
            }

            if (!segments.length) {
                legend.innerHTML = '<p style="color: #9ca3af;">No allocation data available.</p>';
                clearPieChart();
                return;
            }

            segments.forEach(segment => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.background = segment.color || '#6366f1';

                const label = document.createElement('div');
                let value;
                if (typeof segment.value === 'number') {
                    value = segment.value + '%';
                } else {
                    value = segment.value;
                }
                label.textContent = segment.label ? segment.label + ': ' + value : value;

                item.appendChild(color);
                item.appendChild(label);
                legend.appendChild(item);
            });

            drawPieChart(segments);
        }

        function clearPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas || !canvas.getContext) {
                return;
            }
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function drawPieChart(segments) {
            const canvas = document.getElementById('pieChart');
            if (!canvas || !canvas.getContext) {
                return;
            }

            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!segments || !segments.length) {
                return;
            }

            let total = 0;
            segments.forEach(segment => {
                if (typeof segment.value === 'number') {
                    total += segment.value;
                } else {
                    const numericValue = parseFloat(segment.value);
                    if (!Number.isNaN(numericValue)) {
                        total += numericValue;
                    }
                }
            });
            if (total <= 0) {
                total = 1;
            }

            let currentAngle = -Math.PI / 2;

            segments.forEach(segment => {
                let value;
                if (typeof segment.value === 'number') {
                    value = segment.value;
                } else {
                    const numericValue = parseFloat(segment.value);
                    value = Number.isNaN(numericValue) ? 0 : numericValue;
                }
                const sliceAngle = value / total * Math.PI * 2;

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = segment.color || '#6366f1';
                ctx.fill();

                ctx.strokeStyle = '#1a1f3a';
                ctx.lineWidth = 2;
                ctx.stroke();

                currentAngle += sliceAngle;
            });

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.3, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1f3a';
            ctx.fill();
        }

        function renderMetrics(metrics) {
            const grid = document.getElementById('metrics-grid');
            if (!grid) {
                return;
            }
            grid.innerHTML = '';

            if (!metrics.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No metrics available.</p>';
                return;
            }

            // Group metrics by asset
            const grouped = {};
            const order = ['S&P 500', 'BTC', 'ETH', 'SPY', 'QQQ', 'Fed', 'Gold'];

            metrics.forEach(metric => {
                const label = metric.label || '';
                let assetKey = 'Other';

                if (label.includes('S&P 500')) assetKey = 'S&P 500';
                else if (label.includes('BTC')) assetKey = 'BTC';
                else if (label.includes('ETH')) assetKey = 'ETH';
                else if (label.includes('SPY')) assetKey = 'SPY';
                else if (label.includes('QQQ')) assetKey = 'QQQ';
                else if (label.includes('Fed')) assetKey = 'Fed';
                else if (label.includes('Gold')) assetKey = 'Gold';

                if (!grouped[assetKey]) grouped[assetKey] = [];
                grouped[assetKey].push(metric);
            });

            // Render grouped metrics
            order.forEach(assetKey => {
                if (!grouped[assetKey]) return;

                const card = document.createElement('div');
                card.className = 'metric-card';

                // Asset header
                const header = document.createElement('div');
                header.style.cssText = 'font-size: 0.9em; font-weight: 600; color: #818cf8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;';
                header.textContent = assetKey;
                card.appendChild(header);

                // Sort metrics: Resistance/Target first, then Current, then Support
                const sortedMetrics = grouped[assetKey].sort((a, b) => {
                    const labelA = a.label.toLowerCase();
                    const labelB = b.label.toLowerCase();

                    if (labelA.includes('target') || labelA.includes('resistance')) return -1;
                    if (labelB.includes('target') || labelB.includes('resistance')) return 1;
                    if (labelA.includes('current')) return -1;
                    if (labelB.includes('current')) return 1;
                    return 0;
                });

                // Metric items
                sortedMetrics.forEach((metric, idx) => {
                    const item = document.createElement('div');
                    item.style.cssText = idx > 0 ? 'margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(99, 102, 241, 0.2);' : '';

                    const itemLabel = document.createElement('div');
                    itemLabel.style.cssText = 'font-size: 0.75em; color: #9ca3af; margin-bottom: 4px;';
                    itemLabel.textContent = metric.label.replace(assetKey + ' ', '');

                    const itemValue = document.createElement('div');
                    itemValue.style.cssText = 'font-size: 1.1em; font-weight: 600; color: #e0e6f0;';
                    itemValue.textContent = metric.value || '';

                    item.appendChild(itemLabel);
                    item.appendChild(itemValue);
                    card.appendChild(item);
                });

                grid.appendChild(card);
            });

            // Render ungrouped metrics (Fed, Gold, etc.)
            if (grouped['Other']) {
                grouped['Other'].forEach(metric => {
                    const card = document.createElement('div');
                    card.className = 'metric-card';

                    const label = document.createElement('div');
                    label.className = 'metric-label';
                    label.textContent = metric.label || '';

                    const value = document.createElement('div');
                    value.style.cssText = 'font-size: 1.1em; font-weight: 600; color: #e0e6f0;';
                    value.textContent = metric.value || '';

                    card.appendChild(label);
                    card.appendChild(value);
                    grid.appendChild(card);
                });
            }
        }

        function renderCloseProbability(probabilityData) {
            if (!probabilityData) return '';
            
            let spyHtml = '';
            if (probabilityData.SPY) {
                const spy = probabilityData.SPY;
                spyHtml = `
                    <div class="close-probability-card">
                        <h3 class="section-title" style="font-size: 1.2em;">SPY End-of-Day Close Probability</h3>
                        <p><strong>Model:</strong> ${spy.model || 'N/A'}</p>
                        <p><strong>Prob. Close > ${spy.strike_above || 'N/A'}:</strong> ${spy.prob_above || 'N/A'}</p>
                        <p><strong>Prob. Close < ${spy.strike_below || 'N/A'}:</strong> ${spy.prob_below || 'N/A'}</p>
                        <p style="font-size: 0.8em; color: #9ca3af; margin-top: 10px;"><em>Last Updated: ${spy.lastUpdated || 'N/A'}</em></p>
                    </div>
                `;
            }
            // Similar block for QQQ would go here if data existed
            
            return spyHtml;
        }

        function renderCloseProbability(probabilityData) {
            if (!probabilityData) return '';
            
            let spyHtml = '';
            if (probabilityData.SPY) {
                const spy = probabilityData.SPY;
                spyHtml = `
                    <div class="close-probability-card">
                        <h3 class="section-title" style="font-size: 1.2em;">SPY End-of-Day Close Probability</h3>
                        <p><strong>Model:</strong> ${spy.model || 'N/A'}</p>
                        <p><strong>Prob. Close > ${spy.strike_above || 'N/A'}:</strong> ${spy.prob_above || 'N/A'}</p>
                        <p><strong>Prob. Close < ${spy.strike_below || 'N/A'}:</strong> ${spy.prob_below || 'N/A'}</p>
                        <p style="font-size: 0.8em; color: #9ca3af; margin-top: 10px;"><em>Last Updated: ${spy.lastUpdated || 'N/A'}</em></p>
                    </div>
                `;
            }
            // Similar block for QQQ would go here if data existed
            
            return spyHtml;
        }

        function renderProviderTabs(tabs, dailyPlanner, endOfDay) {
            const tabsContainer = document.getElementById('provider-tabs');
            const contentsContainer = document.getElementById('provider-contents');
            if (!tabsContainer || !contentsContainer) {
                return;
            }

            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '';

            // Insert Daily Planner as first tab
            const allTabs = [];
            if (dailyPlanner) {
                allTabs.push({
                    id: 'daily-planner',
                    label: '📅 Daily Planner',
                    isDailyPlanner: true,
                    data: dailyPlanner,
                    endOfDay: endOfDay
                });
            }
            allTabs.push(...tabs);

            if (!allTabs.length) {
                tabsContainer.innerHTML = '<p style="color: #9ca3af;">No provider data available.</p>';
                return;
            }

            allTabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = 'tab' + (index === 0 ? ' active' : '');
                button.textContent = tab.label || 'Tab ' + (index + 1);
                const tabId = tab.id || 'tab-' + index;
                button.dataset.tabTarget = tabId;
                button.addEventListener('click', () => showTab(tabId));
                tabsContainer.appendChild(button);

                const content = document.createElement('div');
                content.className = 'tab-content' + (index === 0 ? ' active' : '');
                content.id = tabId + '-tab';

                if (tab.isDailyPlanner) {
                    // Render Daily Planner content
                    const plannerElement = renderDailyPlanner(tab.data, tab.endOfDay);
                    if (typeof plannerElement === 'string') {
                        content.innerHTML = plannerElement;
                    } else {
                        content.appendChild(plannerElement);
                    }
                } else if (tab.id === 'xsentiment') {
                    // Render X Sentiment custom layout
                    content.innerHTML = renderXSentiment(tab);
                } else if (tab.id === 'media') {
                    // Render Media & Catalysts custom layout
                    content.innerHTML = renderMediaCatalysts(tab);
                } else {
                    // Render AI interpretation at the top if available
                    if (tab.aiInterpretation) {
                        content.innerHTML += renderAIInterpretation(tab.aiInterpretation);
                    }

                    // Render economic calendar for macro tab
                    if (tab.id === 'macro' && tab.economicCalendar) {
                        const calendarSection = renderEconomicCalendar(tab.economicCalendar);
                        content.appendChild(calendarSection);
                    }

                    // Render Close Probability for technicals tab
                    if (tab.id === 'technicals' && tab.closeProbability) {
                        content.innerHTML += renderCloseProbability(tab.closeProbability);
                    }

                    // Render provider insights with enhanced visual design
                    const grid = document.createElement('div');
                    grid.className = 'provider-insights';

                    const providers = Array.isArray(tab.providers) ? tab.providers : [];
                    if (!providers.length) {
                        const empty = document.createElement('p');
                        empty.style.color = '#9ca3af';
                        empty.textContent = 'No insights available.';
                        grid.appendChild(empty);
                    } else {
                        providers.forEach(provider => {
                            const card = document.createElement('div');
                            card.className = 'provider-card';
                            card.style.background = 'rgba(26, 31, 58, 0.6)';
                            card.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                            card.style.borderRadius = '12px';
                            card.style.padding = '20px';
                            card.style.transition = 'all 0.2s ease';
                            card.style.cursor = 'default';

                            // Hover effect
                            card.onmouseenter = function() {
                                this.style.borderColor = 'rgba(99, 102, 241, 0.4)';
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                            };
                            card.onmouseleave = function() {
                                this.style.borderColor = 'rgba(99, 102, 241, 0.2)';
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = 'none';
                            };

                            const name = document.createElement('div');
                            name.className = 'provider-name';
                            name.style.color = '#6366f1';
                            name.style.fontWeight = '600';
                            name.style.fontSize = '1.1em';
                            name.style.marginBottom = '15px';
                            name.style.display = 'flex';
                            name.style.alignItems = 'center';
                            name.style.gap = '8px';

                            // Add emoji based on provider name
                            const emoji = getProviderEmoji(provider.name);
                            name.innerHTML = `<span style="font-size: 1.2em;">${emoji}</span> ${provider.name || ''}`;
                            card.appendChild(name);

                            const insights = Array.isArray(provider.insights) ? provider.insights : [];
                            insights.forEach((insight, idx) => {
                                const insightEl = document.createElement('div');
                                insightEl.className = 'key-insight';
                                insightEl.style.color = '#d1d5db';
                                insightEl.style.lineHeight = '1.7';
                                insightEl.style.marginBottom = '12px';
                                insightEl.innerHTML = `&bull; ${insight}`;
                                card.appendChild(insightEl);
                            });
                            grid.appendChild(card);
                        });
                    }
                    content.appendChild(grid);
                }
                contentsContainer.appendChild(content);
            });
        }


        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId + '-tab');
            });

            document.querySelectorAll('.tab').forEach(button => {
                button.classList.toggle('active', button.dataset.tabTarget === tabId);
            });
        }

        function showDetail(topic) {
            console.log('Showing details for:', topic);
        }

        function showError(message) {
            const banner = document.getElementById('dashboard-error');
            if (!banner) {
                return;
            }
            banner.textContent = message;
            banner.classList.add('active');
        }

        function renderQuickActions(quickActions) {
            const grid = document.getElementById('quick-actions-grid');
            if (!grid) return;

            grid.innerHTML = '';
            if (!quickActions.length) {
                grid.innerHTML = '<p style="color: #9ca3af;">No quick actions available.</p>';
                return;
            }

            quickActions.forEach(action => {
                const card = document.createElement('div');
                card.className = `quick-action-card urgency-${action.urgency || 'low'}`;

                const header = document.createElement('div');
                header.className = 'action-header';

                const icon = document.createElement('span');
                icon.className = 'action-icon';
                icon.textContent = action.icon || '📌';

                const type = document.createElement('span');
                type.className = 'action-type';
                type.textContent = (action.type || 'action').toUpperCase();

                header.appendChild(icon);
                header.appendChild(type);

                const title = document.createElement('h3');
                title.className = 'action-title';
                title.textContent = action.title || 'Action';

                const value = document.createElement('div');
                value.className = 'action-value';
                value.textContent = action.value || '';

                const description = document.createElement('p');
                description.className = 'action-description';
                description.textContent = action.description || '';

                card.appendChild(header);
                card.appendChild(title);
                card.appendChild(value);
                card.appendChild(description);

                grid.appendChild(card);
            });
        }

        function renderSentimentTimeline(sentimentHistory) {
            const canvas = document.getElementById('sentimentChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            if (!sentimentHistory || !sentimentHistory.length) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No sentiment history available', width / 2, height / 2);
                return;
            }

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Draw axes labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px Inter, sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const y = padding + (height - 2 * padding) * i / 4;
                const value = 100 - (i * 25);
                ctx.fillText(value.toString(), padding - 10, y + 4);
            }

            // Calculate points
            const points = sentimentHistory.map((item, index) => {
                const x = padding + (width - 2 * padding) * index / (sentimentHistory.length - 1);
                const y = padding + (height - 2 * padding) * (1 - item.score / 100);
                return { x, y, ...item };
            });

            // Draw gradient fill
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(points[0].x, height - padding);
            points.forEach(point => ctx.lineTo(point.x, point.y));
            ctx.lineTo(points[points.length - 1].x, height - padding);
            ctx.closePath();
            ctx.fill();

            // Draw line
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            points.forEach((point, index) => {
                if (index === 0) ctx.moveTo(point.x, point.y);
                else ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();

            // Draw points
            points.forEach(point => {
                ctx.fillStyle = '#1e1b4b';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                ctx.fill();

                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw date labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '11px Inter, sans-serif';
            ctx.textAlign = 'center';
            points.forEach((point, index) => {
                if (index % Math.ceil(points.length / 5) === 0 || index === points.length - 1) {
                    const date = new Date(point.date);
                    const label = `${date.getMonth() + 1}/${date.getDate()}`;
                    ctx.fillText(label, point.x, height - padding + 20);
                }
            });
        }

        function renderProviderConsensus(providerConsensus) {
            const container = document.getElementById('consensus-items');
            if (!container) return;

            container.innerHTML = '';
            if (!providerConsensus || !providerConsensus.length) {
                container.innerHTML = '<p style="color: #9ca3af;">No consensus data available.</p>';
                return;
            }

            providerConsensus.forEach(item => {
                const consensusItem = document.createElement('div');
                consensusItem.className = 'consensus-item';

                const header = document.createElement('div');
                header.className = 'consensus-header';

                const topic = document.createElement('span');
                topic.className = 'consensus-topic';
                topic.textContent = item.topic || 'Topic';

                const percentage = document.createElement('span');
                percentage.className = 'consensus-percentage';
                percentage.textContent = `${item.agreement || 0}% agree`;

                header.appendChild(topic);
                header.appendChild(percentage);

                const barContainer = document.createElement('div');
                barContainer.className = 'consensus-bar-container';

                const bar = document.createElement('div');
                bar.className = 'consensus-bar';
                bar.style.width = '0%';

                barContainer.appendChild(bar);

                const providers = document.createElement('div');
                providers.className = 'consensus-providers';

                if (item.providers && item.providers.agree) {
                    const agreeDiv = document.createElement('div');
                    agreeDiv.innerHTML = `<strong>Agree:</strong> ${item.providers.agree.join(', ')}`;
                    providers.appendChild(agreeDiv);
                }

                if (item.providers && item.providers.disagree) {
                    const disagreeDiv = document.createElement('div');
                    disagreeDiv.innerHTML = `<strong>Disagree:</strong> ${item.providers.disagree.join(', ')}`;
                    providers.appendChild(disagreeDiv);
                }

                if (item.divergence) {
                    const warning = document.createElement('div');
                    warning.className = 'divergence-warning';
                    warning.textContent = '⚠️ Significant divergence detected';
                    consensusItem.appendChild(warning);
                }

                consensusItem.appendChild(header);
                consensusItem.appendChild(barContainer);
                consensusItem.appendChild(providers);

                container.appendChild(consensusItem);

                // Animate bar
                setTimeout(() => {
                    bar.style.width = `${item.agreement || 0}%`;
                }, 100);
            });
        }

        function renderXSentiment(tab) {
            let html = '';

            // AI Interpretation at top
            if (tab.aiInterpretation) {
                html += renderAIInterpretation(tab.aiInterpretation);
            }

            // Sentiment Score Widget
            html += `
                <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                        <div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 8px;">X/Twitter Sentiment</div>
                            <div style="font-size: 3em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tab.sentimentScore || 'N/A'}<span style="font-size: 0.4em; color: #9ca3af;">/100</span></div>
                            <div style="color: #10b981; font-size: 0.9em; margin-top: 5px;">${tab.sentimentTier || ''}</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 8px;">Contrarian Signal</div>
                            <div style="font-size: 1.5em; font-weight: 600; color: #f59e0b;">${tab.contrarian_signal || 'N/A'}</div>
                            <div style="color: #9ca3af; font-size: 0.8em; margin-top: 5px;">Fear <25 = +5pts | Euphoria >90 = -5pts</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 8px;">Hype Cycle Position</div>
                            <div style="font-size: 1.3em; font-weight: 600; color: #8b5cf6;">${tab.hype_cycle?.position || 'N/A'}</div>
                            <div style="color: #9ca3af; font-size: 0.8em; margin-top: 5px;">Emoji: ${tab.hype_cycle?.emoji_density || 'N/A'} | Caps: ${tab.hype_cycle?.caps_lock_usage || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Sentiment Breakdown Bar Chart
            if (tab.sentiment_breakdown) {
                const breakdown = tab.sentiment_breakdown;
                html += `
                    <div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: #e0e6f0;">Sentiment Breakdown</h3>
                        <div style="display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin-bottom: 10px;">
                            <div style="background: #10b981; width: ${breakdown.extreme_bullish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.extreme_bullish > 5 ? breakdown.extreme_bullish + '%' : ''}</div>
                            <div style="background: #34d399; width: ${breakdown.bullish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.bullish > 5 ? breakdown.bullish + '%' : ''}</div>
                            <div style="background: #6b7280; width: ${breakdown.neutral}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.neutral > 5 ? breakdown.neutral + '%' : ''}</div>
                            <div style="background: #f59e0b; width: ${breakdown.bearish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.bearish > 5 ? breakdown.bearish + '%' : ''}</div>
                            <div style="background: #ef4444; width: ${breakdown.extreme_bearish}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;">${breakdown.extreme_bearish > 5 ? breakdown.extreme_bearish + '%' : ''}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #9ca3af;">
                            <span>🟢 Extreme Bullish (${breakdown.extreme_bullish}%)</span>
                            <span>🟢 Bullish (${breakdown.bullish}%)</span>
                            <span>⚪ Neutral (${breakdown.neutral}%)</span>
                            <span>🟠 Bearish (${breakdown.bearish}%)</span>
                            <span>🔴 Extreme Bearish (${breakdown.extreme_bearish}%)</span>
                        </div>
                    </div>
                `;
            }

            // Crypto & Macro Sentiment Scores (side by side)
            if (tab.cryptoSentiment || tab.macroSentiment) {
                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="color: #8b5cf6; font-weight: 600; font-size: 1.1em; margin-bottom: 10px;">📈 Crypto Sentiment</div>
                            <div style="font-size: 2.5em; font-weight: bold; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tab.cryptoSentiment || 'N/A'}<span style="font-size: 0.4em; color: #9ca3af;">/100</span></div>
                            <div style="color: #10b981; font-size: 0.9em; margin-top: 5px;">BULLISH</div>
                        </div>
                        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="color: #6366f1; font-weight: 600; font-size: 1.1em; margin-bottom: 10px;">📊 Macro Sentiment</div>
                            <div style="font-size: 2.5em; font-weight: bold; background: linear-gradient(135deg, #6366f1, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${tab.macroSentiment || 'N/A'}<span style="font-size: 0.4em; color: #9ca3af;">/100</span></div>
                            <div style="color: #10b981; font-size: 0.9em; margin-top: 5px;">BULLISH</div>
                        </div>
                    </div>
                `;
            }

            // Crypto Trending Tickers
            if (tab.crypto_trending && tab.crypto_trending.top_tickers) {
                html += '<div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 25px;">';
                html += '<h3 style="margin-bottom: 15px; color: #8b5cf6;">🔥 Crypto Trending Tickers (Mention Velocity)</h3>';
                html += '<div style="display: grid; gap: 12px;">';

                tab.crypto_trending.top_tickers.forEach(ticker => {
                    const velocityColor = ticker.velocity.startsWith('+') ? '#10b981' : (ticker.velocity.startsWith('-') ? '#ef4444' : '#8b5cf6');
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.6); border-left: 3px solid ${velocityColor}; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 80px 100px 1fr; gap: 15px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.3em; color: #e0e6f0;">${ticker.ticker}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${ticker.mentions} mentions</div>
                            </div>
                            <div style="color: ${velocityColor}; font-weight: 600; font-size: 1.2em; text-align: center;">${ticker.velocity}</div>
                            <div style="color: #9ca3af; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                        </div>
                    `;
                });

                // Crypto Key Levels Table
                if (tab.crypto_trending.key_levels) {
                    html += '</div><div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(139, 92, 246, 0.2);">';
                    html += '<div style="color: #8b5cf6; font-weight: 600; margin-bottom: 12px;">🎯 Crypto Key Levels (Crowdsourced)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.crypto_trending.key_levels.forEach(level => {
                        const typeColor = level.type === 'Support' ? '#10b981' : '#ef4444';
                        html += `
                            <div style="display: grid; grid-template-columns: 60px 150px 100px 1fr; gap: 12px; padding: 10px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; align-items: center;">
                                <div style="font-weight: 600; color: #8b5cf6;">${level.asset}</div>
                                <div style="font-family: 'Courier New', monospace; color: #e0e6f0; font-weight: 600;">${level.level}</div>
                                <div style="color: ${typeColor}; font-weight: 600; font-size: 0.9em;">${level.type}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${level.consensus}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // Macro Trending Tickers
            if (tab.macro_trending && tab.macro_trending.top_tickers) {
                html += '<div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 25px;">';
                html += '<h3 style="margin-bottom: 15px; color: #6366f1;">📊 Macro Trending Tickers (Mention Velocity)</h3>';
                html += '<div style="display: grid; gap: 12px;">';

                tab.macro_trending.top_tickers.forEach(ticker => {
                    const velocityColor = ticker.velocity.startsWith('+') ? '#10b981' : '#ef4444';
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.6); border-left: 3px solid ${velocityColor}; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 80px 100px 1fr; gap: 15px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.3em; color: #e0e6f0;">${ticker.ticker}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${ticker.mentions} mentions</div>
                            </div>
                            <div style="color: ${velocityColor}; font-weight: 600; font-size: 1.2em; text-align: center;">${ticker.velocity}</div>
                            <div style="color: #9ca3af; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                        </div>
                    `;
                });

                // Emerging Tickers
                if (tab.macro_trending.emerging_tickers && tab.macro_trending.emerging_tickers.length) {
                    html += '</div><div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">🌟 Emerging Tickers (Alpha Opportunities)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.emerging_tickers.forEach(ticker => {
                        html += `
                            <div style="background: rgba(234, 179, 8, 0.1); border-left: 3px solid #eab308; padding: 12px; border-radius: 6px;">
                                <div style="font-weight: 600; color: #fde047; margin-bottom: 4px;">${ticker.ticker} <span style="color: #9ca3af; font-size: 0.85em;">(${ticker.mentions} mentions)</span></div>
                                <div style="color: #9ca3af; font-size: 0.9em; font-style: italic;">${ticker.signal}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Macro Key Levels Table
                if (tab.macro_trending.key_levels) {
                    html += '</div><div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">🎯 Macro Key Levels (Crowdsourced)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.key_levels.forEach(level => {
                        const typeColor = level.type === 'Support' ? '#10b981' : (level.type === 'Resistance' ? '#ef4444' : '#f59e0b');
                        html += `
                            <div style="display: grid; grid-template-columns: 60px 150px 100px 1fr; gap: 12px; padding: 10px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; align-items: center;">
                                <div style="font-weight: 600; color: #6366f1;">${level.asset}</div>
                                <div style="font-family: 'Courier New', monospace; color: #e0e6f0; font-weight: 600;">${level.level}</div>
                                <div style="color: ${typeColor}; font-weight: 600; font-size: 0.9em;">${level.type}</div>
                                <div style="color: #9ca3af; font-size: 0.85em;">${level.consensus}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Event Risk Section
                if (tab.macro_trending.event_risk && tab.macro_trending.event_risk.length) {
                    html += '</div><div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2);">';
                    html += '<div style="color: #6366f1; font-weight: 600; margin-bottom: 12px;">⚠️ Event Risk (High Velocity)</div>';
                    html += '<div style="display: grid; gap: 8px;">';
                    tab.macro_trending.event_risk.forEach(event => {
                        html += `
                            <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 12px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <div style="font-weight: 600; color: #fca5a5;">${event.event}</div>
                                    <div style="color: #10b981; font-weight: 600;">${event.velocity}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="color: #9ca3af; font-size: 0.85em;">${event.date}</div>
                                    <div style="color: #9ca3af; font-size: 0.85em; font-style: italic;">${event.impact}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // Top Narratives with Velocity
            if (tab.top_narratives && tab.top_narratives.length) {
                html += '<div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">';
                html += '<h3 style="margin-bottom: 15px; color: #e0e6f0;">🔥 Trending Narratives (24hr Velocity)</h3>';

                tab.top_narratives.forEach(narrative => {
                    const velocityColor = narrative.velocity.startsWith('+') ? '#10b981' : '#ef4444';
                    html += `
                        <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid ${velocityColor}; padding: 15px; margin-bottom: 12px; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #e0e6f0; flex: 1;">#${narrative.rank} ${narrative.narrative}</div>
                                <div style="text-align: right;">
                                    <div style="color: ${velocityColor}; font-weight: 600; font-size: 1.1em;">${narrative.velocity}</div>
                                    <div style="font-size: 0.85em; color: #9ca3af;">${narrative.trend}</div>
                                </div>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; font-style: italic;">${narrative.signal}</div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Trending Words (Word Frequency Analysis)
            if (tab.trending_words) {
                const tw = tab.trending_words;
                html += '<div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">';
                html += '<h3 style="margin-bottom: 15px; color: #e0e6f0;">📊 Trending Words & Themes</h3>';

                // Top row: Crypto Tickers and Equity Tickers
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';

                // Crypto Tickers
                if (tw.tickers_crypto && tw.tickers_crypto.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">💎 CRYPTO TICKERS (Top 10)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.tickers_crypto.slice(0, 10).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600;">${item.word}</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                // Equity Tickers
                if (tw.tickers_equity && tw.tickers_equity.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">📈 EQUITY TICKERS (Top 10)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.tickers_equity.slice(0, 10).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600;">${item.word}</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                html += '</div>'; // End top row

                // Bottom row: Tech Themes and Macro Themes
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';

                // Tech Themes
                if (tw.tech_themes && tw.tech_themes.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">🔬 TECH THEMES (Top 8)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.tech_themes.slice(0, 8).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600;">${item.word}</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                // Macro Themes
                if (tw.macro_themes && tw.macro_themes.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">🌍 MACRO THEMES (Top 8)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.macro_themes.slice(0, 8).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600;">${item.word}</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                html += '</div>'; // End bottom row

                // Single row: Sentiment Words and Narrative Phrases
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';

                // Sentiment Words
                if (tw.sentiment_words && tw.sentiment_words.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">😊 SENTIMENT WORDS (Top 8)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.sentiment_words.slice(0, 8).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600;">${item.word}</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                // Narrative Phrases
                if (tw.narrative_phrases && tw.narrative_phrases.length) {
                    html += '<div>';
                    html += '<div style="color: #818cf8; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">💬 NARRATIVE PHRASES (Top 8)</div>';
                    html += '<div style="display: grid; gap: 6px;">';
                    tw.narrative_phrases.slice(0, 8).forEach((item, idx) => {
                        const signalColor = item.signal === '🔥 HOT' ? '#ef4444' :
                                          item.signal === '↗️ RISING' ? '#10b981' :
                                          item.signal === '⚠️ COOLING' ? '#f59e0b' : '#6b7280';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(99, 102, 241, 0.05); padding: 8px 12px; border-radius: 6px; border-left: 3px solid ${signalColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #6b7280; font-size: 0.75em; min-width: 20px;">#${idx + 1}</span>
                                    <span style="color: #e0e6f0; font-weight: 600; font-style: italic;">"${item.word}"</span>
                                    <span style="color: #9ca3af; font-size: 0.85em;">${item.mentions}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${signalColor}; font-weight: 600; font-size: 0.9em;">${item.velocity_24h || 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 0.7em;">${item.signal || ''}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                html += '</div>'; // End single row

                html += '</div>'; // End trending words section
            }

            // Influencer Consensus
            if (tab.influencer_consensus) {
                const consensus = tab.influencer_consensus;
                html += `
                    <div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: #e0e6f0;">👥 Influencer Tier Consensus</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Tier 1 (10x weight)</div>
                                <div style="color: #10b981; font-weight: 600;">${consensus.tier1_sentiment}</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Tier 2 (5x weight)</div>
                                <div style="color: #f59e0b; font-weight: 600;">${consensus.tier2_sentiment}</div>
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 12px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Tier 3 (1x weight)</div>
                                <div style="color: #8b5cf6; font-weight: 600;">${consensus.tier3_sentiment}</div>
                            </div>
                        </div>
                        <div style="color: #e0e6f0; font-weight: 600; margin-bottom: 10px;">Notable Calls:</div>
                        ${consensus.notable_calls.map(call => `<div style="color: #9ca3af; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 4px; margin-bottom: 6px;">• ${call}</div>`).join('')}
                    </div>
                `;
            }

            // Standard provider insights at bottom
            html += '<div class="provider-insights">';
            const providers = Array.isArray(tab.providers) ? tab.providers : [];
            providers.forEach(provider => {
                html += `
                    <div class="provider-card">
                        <div class="provider-name">${provider.name || ''}</div>
                        ${(provider.insights || []).map(insight => `<div class="key-insight">${insight}</div>`).join('')}
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        function renderMediaCatalysts(tab) {
            let html = '';

            // AI Interpretation at top
            if (tab.aiInterpretation) {
                html += renderAIInterpretation(tab.aiInterpretation);
            }

            // Render each category
            if (tab.categories && tab.categories.length) {
                tab.categories.forEach(category => {
                    html += `<div style="background: rgba(26, 31, 58, 0.6); border-radius: 12px; padding: 20px; margin-bottom: 25px;">`;
                    html += `<h3 style="margin-bottom: 15px; color: #e0e6f0;">${category.name}</h3>`;
                    html += '<div style="display: grid; gap: 12px;">';

                    if (category.items && category.items.length) {
                        category.items.forEach(item => {
                            // Conviction color mapping
                            const convictionColors = {
                                'HIGH': { bg: 'rgba(16, 185, 129, 0.1)', border: '#10b981', text: '#10b981' },
                                'MEDIUM-HIGH': { bg: 'rgba(34, 197, 94, 0.1)', border: '#22c55e', text: '#22c55e' },
                                'MEDIUM': { bg: 'rgba(245, 158, 11, 0.1)', border: '#f59e0b', text: '#f59e0b' },
                                'LOW': { bg: 'rgba(107, 114, 128, 0.1)', border: '#6b7280', text: '#9ca3af' }
                            };
                            const colors = convictionColors[item.conviction] || convictionColors['MEDIUM'];

                            html += `
                                <div style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; padding: 16px; border-radius: 8px; transition: all 0.2s ease;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #e0e6f0; font-size: 1.1em; margin-bottom: 6px;">${item.title}</div>
                                            <div style="color: #9ca3af; font-size: 0.85em;">${item.date} • ${item.source}</div>
                                        </div>
                                        <div style="background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85em; white-space: nowrap; margin-left: 12px;">
                                            ${item.conviction}
                                        </div>
                                    </div>
                                    <div style="color: #d1d5db; line-height: 1.6; margin-bottom: 12px;">
                                        ${item.blurb}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                            ${(item.tags || []).map(tag => `<span style="background: rgba(99, 102, 241, 0.2); color: #818cf8; padding: 2px 8px; border-radius: 4px; font-size: 0.75em;">${tag}</span>`).join('')}
                                        </div>
                                        ${item.link && item.link.startsWith('http') ? `
                                            <a href="${item.link}" target="_blank" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 16px; border-radius: 6px; text-decoration: none; font-size: 0.85em; font-weight: 600; transition: all 0.2s ease; display: inline-block;">
                                                View Source →
                                            </a>
                                        ` : item.link ? `
                                            <button onclick="showTab('${item.link.replace('#', '').replace('-tab', '')}')" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 16px; border-radius: 6px; border: none; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                                                Go to Tab →
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += '</div></div>';
                });
            }

            return html;
        }

        function applyCardAnimations() {
            const cards = document.querySelectorAll('.provider-card, .metric-card');
            if (!cards.length) {
                return;
            }

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            });

            cards.forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                observer.observe(card);
            });
        }

        // Daily Planner Functions
        function isAfterMarketClose() {
            const now = new Date();
            // Convert to EST/EDT - accounting for DST
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market closes at 4:00 PM EST (16:00 = 960 minutes)
            return timeInMinutes >= 960;
        }

        function getCurrentMarketSession() {
            const now = new Date();
            // Convert to EST/EDT - accounting for DST
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market sessions in EST
            if (timeInMinutes >= 4 * 60 && timeInMinutes < 9 * 60 + 30) {
                return 'preMarket';
            } else if (timeInMinutes >= 9 * 60 + 30 && timeInMinutes < 11 * 60) {
                return 'open';
            } else if (timeInMinutes >= 11 * 60 && timeInMinutes < 13 * 60) {
                return 'midday';
            } else if (timeInMinutes >= 15 * 60 && timeInMinutes < 16 * 60) {
                return 'powerHour';
            } else if (timeInMinutes >= 16 * 60 && timeInMinutes < 20 * 60) {
                return 'afterHours';
            } else {
                return 'afterHours'; // Default to after hours
            }
        }

        function getSessionQuality(sessionKey) {
            // Define trading quality for each session
            const sessionQualities = {
                'preMarket': 'good',      // Good for planning, setting orders (yellow)
                'open': 'optimal',        // Best liquidity, volatility (green)
                'midday': 'poor',         // Lunch lull, low volume (red)
                'powerHour': 'optimal',   // High volume, big moves (green)
                'afterHours': 'poor'      // Low liquidity, wide spreads (red)
            };
            return sessionQualities[sessionKey] || 'neutral';
        }

        function renderDailyPlanner(plannerData, endOfDayData) {
            if (!plannerData) {
                return '<p style="color: #9ca3af;">No daily planner data available.</p>';
            }

            const container = document.createElement('div');

            // Session Indicator - Auto-detect current session
            const sessionIndicator = document.createElement('div');
            const sessionKey = getCurrentMarketSession(); // Use auto-detected session
            const sessionQuality = getSessionQuality(sessionKey);
            sessionIndicator.className = `session-indicator session-quality-${sessionQuality}`;

            const sessionName = document.createElement('div');
            sessionName.className = 'session-name';
            const sessionLabels = {
                'pre-market': 'Pre-Market',
                'preMarket': 'Pre-Market',
                'open': 'Market Open',
                'midday': 'Midday',
                'powerHour': 'Power Hour',
                'afterHours': 'After Hours'
            };
            sessionName.textContent = sessionLabels[sessionKey] || sessionKey;

            const sessionTime = document.createElement('div');
            sessionTime.className = 'session-time';
            const sessionTimes = plannerData.sessionTimes || {};
            sessionTime.textContent = sessionTimes[sessionKey] || '';

            sessionIndicator.appendChild(sessionName);
            sessionIndicator.appendChild(sessionTime);
            container.appendChild(sessionIndicator);

            // AI Interpretation (if available)
            if (plannerData.aiInterpretation) {
                const aiInterpDiv = document.createElement('div');
                aiInterpDiv.innerHTML = renderAIInterpretation(plannerData.aiInterpretation);
                container.appendChild(aiInterpDiv);
            }

            // Planner Grid
            const plannerContainer = document.createElement('div');
            plannerContainer.className = 'planner-container';

            // Priorities Section
            plannerContainer.appendChild(renderPriorityItems(plannerData.priorities));

            // Scheduled Events Section
            plannerContainer.appendChild(renderScheduledEvents(plannerData.scheduledEvents));

            // Key Levels Section
            plannerContainer.appendChild(renderKeyLevels(plannerData.keyLevels));

            // Signal Data Section (if available)
            if (plannerData.signalData) {
                plannerContainer.appendChild(renderSignalData(plannerData.signalData));
            }

            // End of Day Recap Section (always show if data exists)
            if (endOfDayData) {
                plannerContainer.appendChild(renderEndOfDayRecap(endOfDayData));
            }

            container.appendChild(plannerContainer);
            return container;
        }

        function renderPriorityItems(priorities) {
            const section = document.createElement('div');
            section.className = 'priorities-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Today\'s Priorities';
            section.appendChild(title);

            if (!priorities) {
                section.innerHTML += '<p style="color: #9ca3af;">No priorities set.</p>';
                return section;
            }

            ['high', 'medium', 'low'].forEach(priority => {
                const items = priorities[priority] || [];
                if (items.length > 0) {
                    const priorityList = document.createElement('div');
                    priorityList.className = 'priority-list';

                    items.forEach((item, index) => {
                        const priorityItem = document.createElement('div');
                        priorityItem.className = `priority-item ${priority}`;

                        const checkbox = document.createElement('div');
                        checkbox.className = `priority-checkbox ${item.completed ? 'checked' : ''}`;
                        checkbox.dataset.priority = priority;
                        checkbox.dataset.index = index;
                        checkbox.onclick = (e) => toggleTask(e.target);

                        const taskText = document.createElement('span');
                        taskText.textContent = item.task || '';
                        taskText.style.flex = '1';
                        if (item.completed) {
                            taskText.style.textDecoration = 'line-through';
                            taskText.style.opacity = '0.6';
                        }

                        priorityItem.appendChild(checkbox);
                        priorityItem.appendChild(taskText);
                        priorityList.appendChild(priorityItem);
                    });

                    section.appendChild(priorityList);
                }
            });

            return section;
        }

        function renderKeyLevels(keyLevels) {
            const section = document.createElement('div');
            section.className = 'key-levels-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Key Levels';
            section.appendChild(title);

            if (!keyLevels || !keyLevels.length) {
                section.innerHTML += '<p style="color: #9ca3af;">No key levels set.</p>';
                return section;
            }

            const table = document.createElement('table');
            table.className = 'level-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Asset', 'Entry/Support', 'Stop/Breakdown', 'Target/Resistance'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            keyLevels.forEach(level => {
                const row = document.createElement('tr');

                const assetCell = document.createElement('td');
                assetCell.className = 'level-asset';
                assetCell.textContent = level.asset || '';
                row.appendChild(assetCell);

                const entryCell = document.createElement('td');
                entryCell.textContent = level.entry || level.support || '';
                row.appendChild(entryCell);

                const stopCell = document.createElement('td');
                stopCell.textContent = level.stop || level.breakdown || '';
                row.appendChild(stopCell);

                const targetCell = document.createElement('td');
                targetCell.textContent = level.target || level.resistance || '';
                row.appendChild(targetCell);

                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            section.appendChild(table);

            return section;
        }

        function renderScheduledEvents(events) {
            const section = document.createElement('div');
            section.className = 'scheduled-events-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Scheduled Events';
            section.appendChild(title);

            if (!events || !events.length) {
                section.innerHTML += '<p style="color: #9ca3af;">No events scheduled.</p>';
                return section;
            }

            events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';

                const leftContent = document.createElement('div');
                const eventTime = document.createElement('div');
                eventTime.className = 'event-time';
                eventTime.textContent = event.time || '';

                const eventText = document.createElement('div');
                eventText.textContent = event.event || '';
                eventText.style.marginTop = '5px';

                leftContent.appendChild(eventTime);
                leftContent.appendChild(eventText);
                // Optional AI/context note explaining why the event matters
                const aiSnippet =
                    (event && (event.why || event.aiNote || event.note || event.importance || event.aiSnippet)) ||
                    (event.ai && (event.ai.why || event.ai.note || event.ai.summary));
                if (aiSnippet) {
                    const aiNote = document.createElement('div');
                    aiNote.className = 'event-ai-note';
                    aiNote.textContent = aiSnippet;
                    leftContent.appendChild(aiNote);
                }

                const impact = document.createElement('span');
                impact.className = `event-impact ${(event.impact || 'low').toLowerCase()}`;
                impact.textContent = event.impact || 'Low';

                eventItem.appendChild(leftContent);
                eventItem.appendChild(impact);
                section.appendChild(eventItem);
            });

            return section;
        }

        function renderSignalData(signalData) {
            const section = document.createElement('div');
            section.className = 'signal-data-section';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = '📊 Trading Signal Score';
            section.appendChild(title);

            // Composite Score Card
            const scoreCard = document.createElement('div');
            scoreCard.className = 'signal-score-card';

            const scoreHeader = document.createElement('div');
            scoreHeader.className = 'signal-header';

            // Score with Delta
            const scoreContainer = document.createElement('div');
            scoreContainer.style.display = 'flex';
            scoreContainer.style.alignItems = 'center';
            scoreContainer.style.gap = '10px';

            const scoreBadge = document.createElement('div');
            scoreBadge.className = 'signal-composite-score';
            scoreBadge.textContent = signalData.composite || '0';
            scoreContainer.appendChild(scoreBadge);

            // Delta indicator (if available)
            if (signalData.delta !== undefined && signalData.delta !== null) {
                const delta = signalData.delta;
                const deltaSpan = document.createElement('span');
                deltaSpan.style.fontSize = '1.2em';
                deltaSpan.style.fontWeight = '600';
                deltaSpan.style.display = 'flex';
                deltaSpan.style.alignItems = 'center';
                deltaSpan.style.gap = '4px';

                if (delta > 0) {
                    deltaSpan.style.color = '#10b981';
                    deltaSpan.innerHTML = `↑ +${delta}`;
                } else if (delta < 0) {
                    deltaSpan.style.color = '#ef4444';
                    deltaSpan.innerHTML = `↓ ${delta}`;
                } else {
                    deltaSpan.style.color = '#9ca3af';
                    deltaSpan.innerHTML = `→ ${delta}`;
                }
                scoreContainer.appendChild(deltaSpan);
            }

            const tierBadge = document.createElement('div');
            const tierClass = (signalData.tier || 'WEAK').toLowerCase().replace(' ', '-');
            tierBadge.className = `signal-tier tier-${tierClass}`;
            tierBadge.textContent = signalData.tier || 'WEAK';

            scoreHeader.appendChild(scoreContainer);
            scoreHeader.appendChild(tierBadge);
            scoreCard.appendChild(scoreHeader);

            // Setup Type (if applicable)
            if (signalData.setup) {
                const setupBadge = document.createElement('div');
                setupBadge.className = 'signal-setup';
                setupBadge.textContent = '🎯 ' + signalData.setup;
                scoreCard.appendChild(setupBadge);
            }

            // Breakdown
            if (signalData.breakdown) {
                const breakdownDiv = document.createElement('div');
                breakdownDiv.className = 'signal-breakdown';

                const breakdownTitle = document.createElement('div');
                breakdownTitle.className = 'breakdown-title';
                breakdownTitle.textContent = 'Score Breakdown:';
                breakdownDiv.appendChild(breakdownTitle);

                const breakdownGrid = document.createElement('div');
                breakdownGrid.className = 'breakdown-grid';

                const components = [
                    { key: 'trend', label: 'Trend (40%)', weight: 40 },
                    { key: 'breadth', label: 'Breadth (25%)', weight: 25 },
                    { key: 'volatility', label: 'Volatility (20%)', weight: 20 },
                    { key: 'technical', label: 'Technical (10%)', weight: 10 },
                    { key: 'seasonality', label: 'Seasonality (5%)', weight: 5 }
                ];

                components.forEach(comp => {
                    const value = signalData.breakdown[comp.key] || 0;
                    const maxScore = comp.weight;
                    const percentage = ((value / maxScore) * 100).toFixed(0);

                    const item = document.createElement('div');
                    item.className = 'breakdown-item';

                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'breakdown-label';
                    labelDiv.style.display = 'flex';
                    labelDiv.style.alignItems = 'center';
                    labelDiv.style.gap = '6px';

                    // Add trend arrow if available
                    if (signalData.trends && signalData.trends[comp.key]) {
                        const trend = signalData.trends[comp.key];
                        const trendSpan = document.createElement('span');
                        trendSpan.style.fontSize = '0.9em';
                        trendSpan.style.fontWeight = 'bold';

                        if (trend === 'up') {
                            trendSpan.textContent = '↑';
                            trendSpan.style.color = '#10b981';
                            trendSpan.title = 'Improving';
                        } else if (trend === 'down') {
                            trendSpan.textContent = '↓';
                            trendSpan.style.color = '#ef4444';
                            trendSpan.title = 'Declining';
                        } else {
                            trendSpan.textContent = '→';
                            trendSpan.style.color = '#9ca3af';
                            trendSpan.title = 'Flat';
                        }
                        labelDiv.appendChild(trendSpan);
                    }

                    const labelText = document.createElement('span');
                    labelText.textContent = comp.label;
                    labelDiv.appendChild(labelText);

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'breakdown-value';
                    valueDiv.textContent = `${value}/${maxScore}`;

                    const barContainer = document.createElement('div');
                    barContainer.className = 'breakdown-bar-container';

                    const bar = document.createElement('div');
                    bar.className = 'breakdown-bar';
                    bar.style.width = percentage + '%';

                    barContainer.appendChild(bar);

                    item.appendChild(labelDiv);
                    item.appendChild(barContainer);
                    item.appendChild(valueDiv);
                    breakdownGrid.appendChild(item);
                });

                breakdownDiv.appendChild(breakdownGrid);
                scoreCard.appendChild(breakdownDiv);
            }

            // Recommendation with Action Checklist
            if (signalData.recommendation || signalData.actionChecklist) {
                const recommendationSection = document.createElement('div');
                recommendationSection.style.marginTop = '15px';
                recommendationSection.style.padding = '12px';
                recommendationSection.style.background = 'rgba(16, 185, 129, 0.1)';
                recommendationSection.style.border = '1px solid rgba(16, 185, 129, 0.2)';
                recommendationSection.style.borderRadius = '8px';
                recommendationSection.style.borderLeft = '4px solid #10b981';

                // Main recommendation text
                if (signalData.recommendation) {
                    const recommendation = document.createElement('div');
                    recommendation.style.color = '#10b981';
                    recommendation.style.fontWeight = '600';
                    recommendation.style.marginBottom = '10px';
                    recommendation.textContent = '💡 ' + signalData.recommendation;
                    recommendationSection.appendChild(recommendation);
                }

                // Action Checklist (if available)
                if (signalData.actionChecklist && signalData.actionChecklist.length) {
                    const checklistContainer = document.createElement('div');
                    checklistContainer.style.marginTop = '10px';

                    signalData.actionChecklist.forEach(item => {
                        const checkItem = document.createElement('div');
                        checkItem.style.display = 'flex';
                        checkItem.style.alignItems = 'flex-start';
                        checkItem.style.gap = '8px';
                        checkItem.style.padding = '6px 0';
                        checkItem.style.fontSize = '0.9em';
                        checkItem.style.lineHeight = '1.5';

                        // Checkbox/status icon
                        const statusIcon = document.createElement('span');
                        statusIcon.style.fontSize = '1.1em';
                        statusIcon.style.minWidth = '20px';

                        // Priority badge
                        let priorityBadge = '';
                        if (item.priority === 'critical') {
                            statusIcon.style.color = '#ef4444';
                            priorityBadge = '<span style="color: #ef4444; font-weight: 600; margin-right: 4px;">🔴</span>';
                        } else if (item.priority === 'monitor') {
                            statusIcon.style.color = '#f59e0b';
                            priorityBadge = '<span style="color: #f59e0b; font-weight: 600; margin-right: 4px;">🟡</span>';
                        } else {
                            statusIcon.style.color = '#10b981';
                            priorityBadge = '<span style="color: #10b981; font-weight: 600; margin-right: 4px;">🟢</span>';
                        }

                        if (item.completed) {
                            statusIcon.textContent = '✓';
                            statusIcon.style.color = '#10b981';
                        } else if (item.inProgress) {
                            statusIcon.textContent = '⏳';
                            statusIcon.style.color = '#f59e0b';
                        } else {
                            statusIcon.textContent = '○';
                            statusIcon.style.color = '#9ca3af';
                        }

                        const textDiv = document.createElement('div');
                        textDiv.style.flex = '1';
                        textDiv.style.color = item.completed ? '#9ca3af' : '#e0e6f0';
                        textDiv.innerHTML = priorityBadge + (item.completed ? `<s>${item.text}</s>` : item.text);

                        // Target value if available
                        if (item.target) {
                            const targetSpan = document.createElement('span');
                            targetSpan.style.color = '#6366f1';
                            targetSpan.style.fontWeight = '600';
                            targetSpan.style.marginLeft = '8px';
                            targetSpan.textContent = `(${item.target})`;
                            textDiv.appendChild(targetSpan);
                        }

                        checkItem.appendChild(statusIcon);
                        checkItem.appendChild(textDiv);
                        checklistContainer.appendChild(checkItem);
                    });

                    recommendationSection.appendChild(checklistContainer);
                }

                scoreCard.appendChild(recommendationSection);
            }

            section.appendChild(scoreCard);
            return section;
        }

        function isAfterMidDay() {
            const now = new Date();
            // Convert to EST/EDT
            const estTimeString = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
            const estTime = new Date(estTimeString);
            const hours = estTime.getHours();
            const minutes = estTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Midday is 12:00 PM EST (720 minutes)
            return timeInMinutes >= 720;
        }

        function renderCloseProbability(probabilityData) {
            const section = document.createElement('div');
            section.className = 'close-probability-section';
            section.style.marginTop = '25px';
            section.style.padding = '20px';
            section.style.background = 'rgba(139, 92, 246, 0.1)';
            section.style.border = '1px solid rgba(139, 92, 246, 0.3)';
            section.style.borderRadius = '12px';

            const title = document.createElement('h3');
            title.style.color = '#8b5cf6';
            title.style.fontSize = '1.1em';
            title.style.marginBottom = '15px';
            title.style.display = 'flex';
            title.style.alignItems = 'center';
            title.style.justifyContent = 'space-between';

            const titleText = document.createElement('span');
            titleText.textContent = `📊 ${probabilityData.ticker} Close Probability`;

            const updateTime = document.createElement('span');
            updateTime.style.fontSize = '0.75em';
            updateTime.style.color = '#9ca3af';
            updateTime.textContent = `Updated: ${probabilityData.lastUpdate || 'N/A'}`;

            title.appendChild(titleText);
            title.appendChild(updateTime);
            section.appendChild(title);

            // Current price info
            const currentPrice = document.createElement('div');
            currentPrice.style.marginBottom = '15px';
            currentPrice.style.padding = '12px';
            currentPrice.style.background = 'rgba(139, 92, 246, 0.1)';
            currentPrice.style.borderRadius = '8px';
            currentPrice.innerHTML = `
                <div style="color: #e0e6f0; font-size: 0.9em;">Current: <strong style="font-size: 1.2em;">${probabilityData.current}</strong></div>
                <div style="color: #9ca3af; font-size: 0.85em; margin-top: 4px;">${probabilityData.changeFromOpen} from open</div>
            `;
            section.appendChild(currentPrice);

            // Probability bars
            const probTitle = document.createElement('div');
            probTitle.style.color = '#e0e6f0';
            probTitle.style.fontWeight = '600';
            probTitle.style.marginBottom = '10px';
            probTitle.style.fontSize = '0.95em';
            probTitle.textContent = 'Probability Distribution:';
            section.appendChild(probTitle);

            // Higher probability
            const higherDiv = document.createElement('div');
            higherDiv.style.marginBottom = '8px';
            const higherLabel = document.createElement('div');
            higherLabel.style.display = 'flex';
            higherLabel.style.justifyContent = 'space-between';
            higherLabel.style.marginBottom = '4px';
            higherLabel.innerHTML = `
                <span style="color: #10b981; font-size: 0.9em;">🟢 Higher Close (>${probabilityData.current})</span>
                <span style="color: #10b981; font-weight: 600;">${probabilityData.probabilities.higher}%</span>
            `;
            const higherBar = document.createElement('div');
            higherBar.style.height = '24px';
            higherBar.style.background = 'rgba(16, 185, 129, 0.2)';
            higherBar.style.borderRadius = '4px';
            higherBar.style.overflow = 'hidden';
            const higherFill = document.createElement('div');
            higherFill.style.height = '100%';
            higherFill.style.width = `${probabilityData.probabilities.higher}%`;
            higherFill.style.background = '#10b981';
            higherFill.style.transition = 'width 0.5s ease';
            higherBar.appendChild(higherFill);
            higherDiv.appendChild(higherLabel);
            higherDiv.appendChild(higherBar);
            section.appendChild(higherDiv);

            // Flat probability
            const flatDiv = document.createElement('div');
            flatDiv.style.marginBottom = '8px';
            const flatLabel = document.createElement('div');
            flatLabel.style.display = 'flex';
            flatLabel.style.justifyContent = 'space-between';
            flatLabel.style.marginBottom = '4px';
            flatLabel.innerHTML = `
                <span style="color: #9ca3af; font-size: 0.9em;">⚪ Flat (±0.1%)</span>
                <span style="color: #9ca3af; font-weight: 600;">${probabilityData.probabilities.flat}%</span>
            `;
            const flatBar = document.createElement('div');
            flatBar.style.height = '24px';
            flatBar.style.background = 'rgba(156, 163, 175, 0.2)';
            flatBar.style.borderRadius = '4px';
            flatBar.style.overflow = 'hidden';
            const flatFill = document.createElement('div');
            flatFill.style.height = '100%';
            flatFill.style.width = `${probabilityData.probabilities.flat}%`;
            flatFill.style.background = '#9ca3af';
            flatFill.style.transition = 'width 0.5s ease';
            flatBar.appendChild(flatFill);
            flatDiv.appendChild(flatLabel);
            flatDiv.appendChild(flatBar);
            section.appendChild(flatDiv);

            // Lower probability
            const lowerDiv = document.createElement('div');
            lowerDiv.style.marginBottom = '15px';
            const lowerLabel = document.createElement('div');
            lowerLabel.style.display = 'flex';
            lowerLabel.style.justifyContent = 'space-between';
            lowerLabel.style.marginBottom = '4px';
            lowerLabel.innerHTML = `
                <span style="color: #ef4444; font-size: 0.9em;">🔴 Lower Close (<${probabilityData.current})</span>
                <span style="color: #ef4444; font-weight: 600;">${probabilityData.probabilities.lower}%</span>
            `;
            const lowerBar = document.createElement('div');
            lowerBar.style.height = '24px';
            lowerBar.style.background = 'rgba(239, 68, 68, 0.2)';
            lowerBar.style.borderRadius = '4px';
            lowerBar.style.overflow = 'hidden';
            const lowerFill = document.createElement('div');
            lowerFill.style.height = '100%';
            lowerFill.style.width = `${probabilityData.probabilities.lower}%`;
            lowerFill.style.background = '#ef4444';
            lowerFill.style.transition = 'width 0.5s ease';
            lowerBar.appendChild(lowerFill);
            lowerDiv.appendChild(lowerLabel);
            lowerDiv.appendChild(lowerBar);
            section.appendChild(lowerDiv);

            // Key factors
            if (probabilityData.factors && probabilityData.factors.length) {
                const factorsTitle = document.createElement('div');
                factorsTitle.style.color = '#e0e6f0';
                factorsTitle.style.fontWeight = '600';
                factorsTitle.style.marginBottom = '8px';
                factorsTitle.style.marginTop = '15px';
                factorsTitle.style.fontSize = '0.95em';
                factorsTitle.textContent = 'Key Factors:';
                section.appendChild(factorsTitle);

                probabilityData.factors.forEach(factor => {
                    const factorDiv = document.createElement('div');
                    factorDiv.style.display = 'flex';
                    factorDiv.style.alignItems = 'center';
                    factorDiv.style.gap = '8px';
                    factorDiv.style.padding = '6px 0';
                    factorDiv.style.fontSize = '0.9em';
                    factorDiv.style.lineHeight = '1.5';

                    const icon = document.createElement('span');
                    icon.style.fontSize = '1.1em';
                    if (factor.impact === 'bullish') {
                        icon.textContent = '✓';
                        icon.style.color = '#10b981';
                    } else if (factor.impact === 'bearish') {
                        icon.textContent = '✗';
                        icon.style.color = '#ef4444';
                    } else {
                        icon.textContent = '⚠️';
                        icon.style.color = '#f59e0b';
                    }

                    const text = document.createElement('span');
                    text.style.color = '#d1d5db';
                    text.textContent = factor.text;

                    factorDiv.appendChild(icon);
                    factorDiv.appendChild(text);
                    section.appendChild(factorDiv);
                });
            }

            // Composite signal
            const composite = document.createElement('div');
            composite.style.marginTop = '15px';
            composite.style.padding = '12px';
            composite.style.background = 'rgba(139, 92, 246, 0.15)';
            composite.style.borderRadius = '8px';
            composite.style.display = 'flex';
            composite.style.justifyContent = 'space-between';
            composite.style.alignItems = 'center';
            composite.innerHTML = `
                <div>
                    <div style="color: #e0e6f0; font-size: 0.9em; margin-bottom: 4px;">Composite Signal:</div>
                    <div style="color: ${probabilityData.compositeSignal.color}; font-weight: 700; font-size: 1.1em;">${probabilityData.compositeSignal.label} (${probabilityData.compositeSignal.score}/100)</div>
                </div>
                <div style="text-align: right;">
                    <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 4px;">Confidence:</div>
                    <div style="color: #8b5cf6; font-weight: 600;">${probabilityData.confidence}</div>
                </div>
            `;
            section.appendChild(composite);

            return section;
        }

        function renderEndOfDayRecap(recapData) {
            const section = document.createElement('div');
            section.className = 'eod-recap-section';
            section.style.marginTop = '30px';
            section.style.borderTop = '2px solid rgba(99, 102, 241, 0.3)';
            section.style.paddingTop = '25px';
            section.style.gridColumn = '1 / -1'; // Span all columns

            // Header with collapsible toggle
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '15px';

            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = `📊 End of Day Recap - ${recapData.date || 'Previous Day'}`;
            title.style.margin = '0';

            const timestamp = document.createElement('div');
            timestamp.style.fontSize = '0.85em';
            timestamp.style.color = '#9ca3af';
            timestamp.style.marginLeft = '12px';
            if (recapData.ranAt) {
                timestamp.textContent = recapData.ranAt;
            }

            // Collapsible content
            const content = document.createElement('div');
            content.id = 'eod-recap-content';
            content.style.display = 'none'; // Collapsed by default

            const toggleButton = document.createElement('button');
            toggleButton.id = 'eod-toggle-btn';
            toggleButton.style.background = 'rgba(99, 102, 241, 0.2)';
            toggleButton.style.border = '1px solid rgba(99, 102, 241, 0.4)';
            toggleButton.style.color = '#6366f1';
            toggleButton.style.padding = '6px 12px';
            toggleButton.style.borderRadius = '6px';
            toggleButton.style.cursor = 'pointer';
            toggleButton.style.fontSize = '0.9em';
            toggleButton.textContent = '▼ Show';
            toggleButton.onclick = function() {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                this.textContent = isHidden ? '▲ Hide' : '▼ Show';
            };

            header.appendChild(title);
            header.appendChild(timestamp);
            header.appendChild(toggleButton);
            section.appendChild(header);

            // Summary paragraph
            if (recapData.summary) {
                const summaryDiv = document.createElement('div');
                summaryDiv.style.background = 'rgba(99, 102, 241, 0.1)';
                summaryDiv.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                summaryDiv.style.borderRadius = '8px';
                summaryDiv.style.padding = '15px';
                summaryDiv.style.marginBottom = '15px';
                summaryDiv.style.color = '#e0e6f0';
                summaryDiv.style.lineHeight = '1.6';
                summaryDiv.textContent = recapData.summary;
                content.appendChild(summaryDiv);
            }

            // Key Outcomes
            if (recapData.keyOutcomes && recapData.keyOutcomes.length) {
                const outcomesSection = document.createElement('div');
                outcomesSection.style.marginBottom = '15px';

                const outcomesTitle = document.createElement('h4');
                outcomesTitle.style.color = '#6366f1';
                outcomesTitle.style.fontSize = '1em';
                outcomesTitle.style.marginBottom = '8px';
                outcomesTitle.textContent = '🎯 Key Outcomes';
                outcomesSection.appendChild(outcomesTitle);

                const outcomesList = document.createElement('ul');
                outcomesList.style.color = '#e0e6f0';
                outcomesList.style.lineHeight = '1.7';
                outcomesList.style.marginLeft = '20px';

                recapData.keyOutcomes.forEach(outcome => {
                    const li = document.createElement('li');
                    li.textContent = outcome;
                    li.style.marginBottom = '6px';
                    outcomesList.appendChild(li);
                });

                outcomesSection.appendChild(outcomesList);
                content.appendChild(outcomesSection);
            }

            // Signals Snapshot
            if (recapData.signals) {
                const signalsSection = document.createElement('div');
                signalsSection.style.marginBottom = '15px';
                signalsSection.style.background = 'rgba(16, 185, 129, 0.1)';
                signalsSection.style.border = '1px solid rgba(16, 185, 129, 0.2)';
                signalsSection.style.borderRadius = '8px';
                signalsSection.style.padding = '12px';

                const signalsTitle = document.createElement('h4');
                signalsTitle.style.color = '#10b981';
                signalsTitle.style.fontSize = '1em';
                signalsTitle.style.marginBottom = '8px';
                signalsTitle.textContent = '📈 Signals Snapshot';
                signalsSection.appendChild(signalsTitle);

                const signalsText = document.createElement('div');
                signalsText.style.color = '#e0e6f0';
                signalsText.style.lineHeight = '1.6';
                signalsText.innerHTML = `
                    <strong>Composite:</strong> ${recapData.signals.composite || 'N/A'}/100 (${recapData.signals.tier || 'N/A'})<br>
                    <strong>Drivers:</strong> ${(recapData.signals.drivers || []).join(', ')}<br>
                    <strong>X Sentiment:</strong> ${recapData.signals.xSentiment || 'N/A'}
                `;
                signalsSection.appendChild(signalsText);
                content.appendChild(signalsSection);
            }

            // 1. Signal Score Trend (5-7 day chart)
            if (recapData.trendAnalysis && recapData.trendAnalysis.signalScoreTrend) {
                const trendSection = document.createElement('div');
                trendSection.style.marginBottom = '15px';
                trendSection.style.background = 'rgba(99, 102, 241, 0.1)';
                trendSection.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                trendSection.style.borderRadius = '8px';
                trendSection.style.padding = '12px';

                const trendTitle = document.createElement('h4');
                trendTitle.style.color = '#6366f1';
                trendTitle.style.fontSize = '1em';
                trendTitle.style.marginBottom = '8px';
                trendTitle.textContent = '📊 Signal Score Trend (7-Day)';
                trendSection.appendChild(trendTitle);

                const trend = recapData.trendAnalysis.signalScoreTrend;

                // Mini chart display
                const chartContainer = document.createElement('div');
                chartContainer.style.display = 'flex';
                chartContainer.style.alignItems = 'flex-end';
                chartContainer.style.height = '60px';
                chartContainer.style.gap = '4px';
                chartContainer.style.marginBottom = '10px';

                if (trend.scores && trend.scores.length) {
                    const maxScore = Math.max(...trend.scores);
                    trend.scores.forEach((score, idx) => {
                        const bar = document.createElement('div');
                        bar.style.flex = '1';
                        bar.style.background = score >= 70 ? '#10b981' : score >= 50 ? '#6366f1' : '#f59e0b';
                        bar.style.height = `${(score / 100) * 60}px`;
                        bar.style.borderRadius = '4px 4px 0 0';
                        bar.style.position = 'relative';
                        bar.title = `Day ${idx + 1}: ${score}`;
                        chartContainer.appendChild(bar);
                    });
                }
                trendSection.appendChild(chartContainer);

                // Trend summary
                const trendSummary = document.createElement('div');
                trendSummary.style.color = '#e0e6f0';
                trendSummary.style.fontSize = '0.9em';
                trendSummary.style.lineHeight = '1.6';
                trendSummary.innerHTML = `
                    <strong>Trend:</strong> ${trend.direction || 'N/A'} (${trend.change || 'N/A'} points over 7 days)<br>
                    ${trend.tierTransitions ? `<strong>Tier Changes:</strong> ${trend.tierTransitions}<br>` : ''}
                    <strong>Analysis:</strong> ${trend.summary || 'No trend data available'}
                `;
                trendSection.appendChild(trendSummary);
                content.appendChild(trendSection);
            }

            // 3. Volatility Pattern Detection
            if (recapData.trendAnalysis && recapData.trendAnalysis.volatilityPattern) {
                const volSection = document.createElement('div');
                volSection.style.marginBottom = '15px';
                volSection.style.background = 'rgba(245, 158, 11, 0.1)';
                volSection.style.border = '1px solid rgba(245, 158, 11, 0.2)';
                volSection.style.borderRadius = '8px';
                volSection.style.padding = '12px';

                const volTitle = document.createElement('h4');
                volTitle.style.color = '#f59e0b';
                volTitle.style.fontSize = '1em';
                volTitle.style.marginBottom = '8px';
                volTitle.textContent = '⚡ Volatility Pattern';
                volSection.appendChild(volTitle);

                const vol = recapData.trendAnalysis.volatilityPattern;

                const volContent = document.createElement('div');
                volContent.style.color = '#e0e6f0';
                volContent.style.fontSize = '0.9em';
                volContent.style.lineHeight = '1.6';
                volContent.innerHTML = `
                    <strong>VIX Change:</strong> ${vol.vixChange || 'N/A'} (${vol.vixChangePercent || 'N/A'})<br>
                    <strong>Pattern:</strong> ${vol.pattern || 'Normal'} ${vol.isUnusual ? '⚠️ <span style="color: #ef4444;">UNUSUAL SPIKE</span>' : ''}<br>
                    <strong>Status:</strong> ${vol.status || 'N/A'}<br>
                    <strong>Context:</strong> ${vol.context || 'No pattern detected'}
                `;
                volSection.appendChild(volContent);
                content.appendChild(volSection);
            }

            // 4. Breadth Divergence Tracker
            if (recapData.trendAnalysis && recapData.trendAnalysis.breadthDivergence) {
                const breadthSection = document.createElement('div');
                breadthSection.style.marginBottom = '15px';
                breadthSection.style.background = 'rgba(239, 68, 68, 0.1)';
                breadthSection.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                breadthSection.style.borderRadius = '8px';
                breadthSection.style.padding = '12px';

                const breadthTitle = document.createElement('h4');
                breadthTitle.style.color = '#ef4444';
                breadthTitle.style.fontSize = '1em';
                breadthTitle.style.marginBottom = '8px';
                breadthTitle.textContent = '📉 Breadth Divergence';
                breadthSection.appendChild(breadthTitle);

                const breadth = recapData.trendAnalysis.breadthDivergence;

                const breadthContent = document.createElement('div');
                breadthContent.style.color = '#e0e6f0';
                breadthContent.style.fontSize = '0.9em';
                breadthContent.style.lineHeight = '1.6';
                breadthContent.innerHTML = `
                    <strong>Status:</strong> ${breadth.isDiverging ? '<span style="color: #ef4444;">⚠️ DIVERGING</span>' : '<span style="color: #10b981;">✓ ALIGNED</span>'}<br>
                    <strong>Consecutive Days:</strong> ${breadth.consecutiveDays || 0} day(s)<br>
                    <strong>Historical Context:</strong> ${breadth.historicalContext || 'N/A'}<br>
                    <strong>Implication:</strong> ${breadth.implication || 'Monitor for potential reversal or continuation'}
                `;
                breadthSection.appendChild(breadthContent);
                content.appendChild(breadthSection);
            }

            // 5. Narrative Momentum
            if (recapData.trendAnalysis && recapData.trendAnalysis.narrativeMomentum) {
                const narrativeSection = document.createElement('div');
                narrativeSection.style.marginBottom = '15px';
                narrativeSection.style.background = 'rgba(139, 92, 246, 0.1)';
                narrativeSection.style.border = '1px solid rgba(139, 92, 246, 0.2)';
                narrativeSection.style.borderRadius = '8px';
                narrativeSection.style.padding = '12px';

                const narrativeTitle = document.createElement('h4');
                narrativeTitle.style.color = '#8b5cf6';
                narrativeTitle.style.fontSize = '1em';
                narrativeTitle.style.marginBottom = '8px';
                narrativeTitle.textContent = '🔥 Narrative Momentum';
                narrativeSection.appendChild(narrativeTitle);

                const narratives = recapData.trendAnalysis.narrativeMomentum;

                // Hot narratives
                if (narratives.hot && narratives.hot.length) {
                    const hotDiv = document.createElement('div');
                    hotDiv.style.marginBottom = '10px';
                    hotDiv.innerHTML = '<strong style="color: #10b981;">📈 Gaining Steam:</strong>';
                    const hotList = document.createElement('ul');
                    hotList.style.marginLeft = '20px';
                    hotList.style.marginTop = '5px';
                    hotList.style.color = '#e0e6f0';
                    narratives.hot.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${item.narrative}</strong> - ${item.trend} (${item.days} days)`;
                        hotList.appendChild(li);
                    });
                    hotDiv.appendChild(hotList);
                    narrativeSection.appendChild(hotDiv);
                }

                // Cooling narratives
                if (narratives.cooling && narratives.cooling.length) {
                    const coolingDiv = document.createElement('div');
                    coolingDiv.innerHTML = '<strong style="color: #f59e0b;">📉 Losing Steam:</strong>';
                    const coolingList = document.createElement('ul');
                    coolingList.style.marginLeft = '20px';
                    coolingList.style.marginTop = '5px';
                    coolingList.style.color = '#e0e6f0';
                    narratives.cooling.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${item.narrative}</strong> - ${item.trend} (${item.days} days)`;
                        coolingList.appendChild(li);
                    });
                    coolingDiv.appendChild(coolingList);
                    narrativeSection.appendChild(coolingDiv);
                }

                content.appendChild(narrativeSection);
            }

            // Actions Completed & Deferred
            if (recapData.actions) {
                const actionsSection = document.createElement('div');
                actionsSection.style.marginBottom = '15px';

                const actionsTitle = document.createElement('h4');
                actionsTitle.style.color = '#6366f1';
                actionsTitle.style.fontSize = '1em';
                actionsTitle.style.marginBottom = '8px';
                actionsTitle.textContent = '✅ Actions';
                actionsSection.appendChild(actionsTitle);

                if (recapData.actions.completed && recapData.actions.completed.length) {
                    const completedLabel = document.createElement('div');
                    completedLabel.style.color = '#10b981';
                    completedLabel.style.fontWeight = '600';
                    completedLabel.style.marginTop = '8px';
                    completedLabel.textContent = 'Completed:';
                    actionsSection.appendChild(completedLabel);

                    const completedList = document.createElement('ul');
                    completedList.style.color = '#e0e6f0';
                    completedList.style.lineHeight = '1.7';
                    completedList.style.marginLeft = '20px';
                    completedList.style.marginBottom = '8px';

                    recapData.actions.completed.forEach(action => {
                        const li = document.createElement('li');
                        li.textContent = action;
                        li.style.marginBottom = '4px';
                        completedList.appendChild(li);
                    });

                    actionsSection.appendChild(completedList);
                }

                if (recapData.actions.deferred && recapData.actions.deferred.length) {
                    const deferredLabel = document.createElement('div');
                    deferredLabel.style.color = '#f59e0b';
                    deferredLabel.style.fontWeight = '600';
                    deferredLabel.style.marginTop = '8px';
                    deferredLabel.textContent = 'Deferred:';
                    actionsSection.appendChild(deferredLabel);

                    const deferredList = document.createElement('ul');
                    deferredList.style.color = '#e0e6f0';
                    deferredList.style.lineHeight = '1.7';
                    deferredList.style.marginLeft = '20px';

                    recapData.actions.deferred.forEach(action => {
                        const li = document.createElement('li');
                        li.textContent = action;
                        li.style.marginBottom = '4px';
                        deferredList.appendChild(li);
                    });

                    actionsSection.appendChild(deferredList);
                }

                content.appendChild(actionsSection);
            }

            // Notes
            if (recapData.notes) {
                const notesDiv = document.createElement('div');
                notesDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                notesDiv.style.border = '1px solid rgba(245, 158, 11, 0.2)';
                notesDiv.style.borderRadius = '8px';
                notesDiv.style.padding = '12px';
                notesDiv.style.color = '#e0e6f0';
                notesDiv.style.lineHeight = '1.6';
                notesDiv.innerHTML = `<strong style="color: #f59e0b;">💡 Notes:</strong> ${recapData.notes}`;
                content.appendChild(notesDiv);
            }

            section.appendChild(content);
            return section;
        }

        function toggleTask(checkbox) {
            checkbox.classList.toggle('checked');
            const taskText = checkbox.nextElementSibling;
            if (checkbox.classList.contains('checked')) {
                taskText.style.textDecoration = 'line-through';
                taskText.style.opacity = '0.6';
            } else {
                taskText.style.textDecoration = 'none';
                taskText.style.opacity = '1';
            }
        }

        function renderEconomicCalendar(calendar) {
            if (!calendar) return document.createElement('div');

            const container = document.createElement('div');
            container.className = 'economic-calendar';

            // Header
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.innerHTML = '<span style="font-size: 1.5em;">📅</span><div class="calendar-title">Economic Calendar</div>';
            container.appendChild(header);

            // Summary
            if (calendar.summary) {
                const summary = document.createElement('div');
                summary.className = 'calendar-summary';
                summary.textContent = calendar.summary;
                container.appendChild(summary);
            }

            // Today's Events
            if (calendar.today && calendar.today.length > 0) {
                const todaySection = document.createElement('div');
                todaySection.className = 'calendar-section';

                const todayHeader = document.createElement('div');
                todayHeader.className = 'calendar-section-header';
                todayHeader.innerHTML = '🔴 TODAY';
                todaySection.appendChild(todayHeader);

                const todayEvents = document.createElement('div');
                todayEvents.className = 'calendar-events';

                calendar.today.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    todayEvents.appendChild(eventDiv);
                });

                todaySection.appendChild(todayEvents);
                container.appendChild(todaySection);
            }

            // This Week's Events
            if (calendar.thisWeek && calendar.thisWeek.length > 0) {
                const weekSection = document.createElement('div');
                weekSection.className = 'calendar-section';

                const weekHeader = document.createElement('div');
                weekHeader.className = 'calendar-section-header';
                weekHeader.innerHTML = '📊 THIS WEEK';
                weekSection.appendChild(weekHeader);

                const weekEvents = document.createElement('div');
                weekEvents.className = 'calendar-events';

                calendar.thisWeek.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.date} ${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    weekEvents.appendChild(eventDiv);
                });

                weekSection.appendChild(weekEvents);
                container.appendChild(weekSection);
            }

            // Next Week's Events
            if (calendar.nextWeek && calendar.nextWeek.length > 0) {
                const nextWeekSection = document.createElement('div');
                nextWeekSection.className = 'calendar-section';

                const nextWeekHeader = document.createElement('div');
                nextWeekHeader.className = 'calendar-section-header';
                nextWeekHeader.innerHTML = '📅 NEXT WEEK';
                nextWeekSection.appendChild(nextWeekHeader);

                const nextWeekEvents = document.createElement('div');
                nextWeekEvents.className = 'calendar-events';

                calendar.nextWeek.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event impact-${event.impact}`;

                    eventDiv.innerHTML = `
                        <div class="event-time">${event.date} ${event.time}</div>
                        <div class="event-name">${event.event}</div>
                        <div class="event-impact ${event.impact}">${event.impact}</div>
                    `;

                    nextWeekEvents.appendChild(eventDiv);
                });

                nextWeekSection.appendChild(nextWeekEvents);
                container.appendChild(nextWeekSection);
            }

            // Key Dates
            if (calendar.keyDates && calendar.keyDates.length > 0) {
                const keyDatesSection = document.createElement('div');
                keyDatesSection.className = 'calendar-section';

                const keyDatesHeader = document.createElement('div');
                keyDatesHeader.className = 'calendar-section-header';
                keyDatesHeader.innerHTML = '🎯 KEY DATES THIS MONTH';
                keyDatesSection.appendChild(keyDatesHeader);

                calendar.keyDates.forEach(keyDate => {
                    const card = document.createElement('div');
                    card.className = 'key-date-card';

                    const header = document.createElement('div');
                    header.className = 'key-date-header';
                    header.innerHTML = `<div class="key-date-date">${keyDate.date}</div>`;
                    card.appendChild(header);

                    const events = document.createElement('div');
                    events.className = 'key-date-events';
                    events.textContent = keyDate.events.join(' • ');
                    card.appendChild(events);

                    if (keyDate.note) {
                        const note = document.createElement('div');
                        note.className = 'key-date-note';
                        note.textContent = keyDate.note;
                        card.appendChild(note);
                    }

                    keyDatesSection.appendChild(card);
                });

                container.appendChild(keyDatesSection);
            }

            return container;
        }

        function renderAIInterpretation(interpretation) {
            if (!interpretation) return '';

            const sentimentClass = `sentiment-${interpretation.sentiment.toLowerCase().replace(/\s+/g, '-')}`;
            const confidenceClass = `confidence-${interpretation.confidence.toLowerCase()}`;

            return `
                <div class="ai-interpretation">
                    <div class="ai-badge">
                        <span>🤖</span>
                        <span>AI INTERPRETATION</span>
                    </div>
                    <div class="ai-summary">${interpretation.summary}</div>
                    <div class="ai-key-insight">
                        <div class="ai-key-insight-label">💡 Key Insight</div>
                        <div class="ai-key-insight-text">${interpretation.keyInsight}</div>
                    </div>
                    <div class="ai-action">
                        <div class="ai-action-icon">⚡</div>
                        <div class="ai-action-text"><strong>Action:</strong> ${interpretation.action}</div>
                    </div>
                    <div class="ai-meta">
                        <div class="ai-sentiment">
                            <span style="color: #9ca3af;">Sentiment:</span>
                            <span class="ai-sentiment-value ${sentimentClass}">${interpretation.sentiment.charAt(0).toUpperCase() + interpretation.sentiment.slice(1)}</span>
                        </div>
                        <div class="ai-confidence">
                            <span style="color: #9ca3af;">Confidence:</span>
                            <span class="ai-confidence-value ${confidenceClass}">${interpretation.confidence.charAt(0).toUpperCase() + interpretation.confidence.slice(1)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getProviderEmoji(providerName) {
            const emojiMap = {
                '42 Macro': '📊',
                'Fundstrat Capital': '📈',
                'Raoul Pal': '🌐',
                'Bankless': '🏦',
                'Unchained': '🔗',
                'Trader Mayne': '📉',
                'Franklin Templeton': '🏛️',
                'Whalemap': '🐋',
                'All-In Podcast': '🎙️',
                'Ripster , Tenet Trade Group': '💹',
                'CNBC': '📺',
                'CoinDesk': '📰',
                'MarketWatch': '📊',
                'Seeking Alpha': '💼',
                'Investing.com': '💰',
                'TradingView SPX': '📈',
                'TradingView BTC': '₿',
                'TradingView QQQ': '💻',
                'TradingView SOL': '☀️',
                'Volatility Metrics': '📊',
                'CoinGlass': '🔍',
                'Fear and Greed Index': '😱',
                'Market Breadth': '📊',
                'Gold': '🥇',
                'X Social Macro Signals': '🐦',
                'X Institutional Flows': '💼',
                'X Altcoin Rotation Signals': '🔄',
                'X Narrative Exhaustion': '⚠️',
                'X Crowd-Sourced Levels': '👥',
                'X Hype Cycle as Vol Predictor': '🎢'
            };

            return emojiMap[providerName] || '📌';
        }

        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>










<!-- Patch: define normalizeCloseProbability and guard Technicals rendering -->
<script>
(function(){
  if (window.__normalizeClosePPatched) return;
  window.__normalizeClosePPatched = true;

  if (typeof window.normalizeCloseProbability !== 'function') {
    window.normalizeCloseProbability = function(raw) {
      if (!raw) return { probabilities: { higher:0, flat:0, lower:0 }, keyLevels: {}, factors: [] };
      const higher = raw.probabilities && Number.isFinite(+raw.probabilities.higher) ? +raw.probabilities.higher
                    : parseInt((raw.prob_above||'').toString().replace('%','')) || 0;
      const lower  = raw.probabilities && Number.isFinite(+raw.probabilities.lower) ? +raw.probabilities.lower
                    : parseInt((raw.prob_below||'').toString().replace('%','')) || 0;
      const flat   = raw.probabilities && Number.isFinite(+raw.probabilities.flat) ? +raw.probabilities.flat
                    : Math.max(0, 100 - higher - lower);
      return {
        ticker: 'SPY',
        current: raw.current || '—',
        changeFromOpen: raw.changeFromOpen || '',
        lastUpdate: raw.lastUpdated || 'N/A',
        probabilities: { higher, flat, lower },
        keyLevels: raw.keyLevels || {},
        factors: raw.factors || [],
        compositeSignal: raw.compositeSignal || { color: '#8b5cf6', label: 'NEUTRAL', score: 50 },
        confidence: raw.confidence || 'MEDIUM'
      };
    };
  }
})();
</script>

